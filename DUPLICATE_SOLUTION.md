# Решение проблемы дубликатов книг в базе данных

## Проблема
В базе данных обнаружены дубликаты книг, что приводит к некорректному отображению и увеличению размера базы данных.

## Причины
1. Недостаточная проверка дубликатов при импорте
2. Повторная синхронизация без proper проверки существующих записей
3. Отсутствие уникальных ограничений в базе данных

## Решения

### 1. Улучшенная проверка дубликатов в sync/route.ts
Внесены изменения в логику проверки существующих книг:
- Расширена проверка с учетом года публикации
- Добавлен fallback на простую проверку в случае ошибок

### 2. Скрипты для работы с дубликатами

#### a. Поиск дубликатов (src/scripts/find-duplicates.ts)
Скрипт для идентификации дубликатов без их удаления:
```bash
npx tsx src/scripts/find-duplicates.ts
```

#### b. Удаление дубликатов (src/scripts/remove-duplicates.ts)
Скрипт для безопасного удаления дубликатов (оставляет самые старые записи):
```bash
npx tsx src/scripts/remove-duplicates.ts
```

#### c. Комплексная очистка (src/scripts/cleanup-database.ts)
Полный скрипт очистки базы данных:
```bash
npx tsx src/scripts/cleanup-database.ts
```

### 3. SQL миграция для удаления дубликатов (supabase/migrations/011_remove_book_duplicates.sql)
```sql
-- Удаление дубликатов книг, оставляя только самые старые записи
WITH duplicates AS (
  SELECT 
    id,
    title,
    author,
    created_at,
    ROW_NUMBER() OVER (
      PARTITION BY title, author 
      ORDER BY created_at ASC
    ) as rn
  FROM books
)
DELETE FROM books 
WHERE id IN (
  SELECT id 
  FROM duplicates 
  WHERE rn > 1
);
```

### 4. Улучшенная проверка дубликатов (src/scripts/enhanced-duplicate-check.ts)
Модуль с функциями для более точной проверки дубликатов:
- `checkForDuplicates` - точная проверка по названию, автору и году
- `findSimilarBooks` - поиск похожих книг для предотвращения дубликатов

## Рекомендованный порядок действий

1. **Анализ**: Запустить скрипт поиска дубликатов для понимания масштаба проблемы
   ```bash
   npx tsx src/scripts/find-duplicates.ts
   ```

2. **Очистка**: Запустить комплексный скрипт очистки
   ```bash
   npx tsx src/scripts/cleanup-database.ts
   ```

3. **Проверка**: Убедиться, что дубликаты удалены
   ```bash
   npx tsx src/scripts/find-duplicates.ts
   ```

4. **Предотвращение**: В будущем использовать улучшенную логику проверки дубликатов

## Дополнительные меры

1. **Добавление уникальных ограничений** (опционально):
   ```sql
   ALTER TABLE books ADD CONSTRAINT unique_title_author UNIQUE (title, author);
   ```

2. **Регулярная проверка**: Запускать скрипты проверки дубликатов定期 для поддержания чистоты базы данных

## Важно
- Все операции удаления необратимы
- Рекомендуется сделать резервную копию базы данных перед запуском скриптов очистки
- Тестировать скрипты на копии базы данных перед запуском на production