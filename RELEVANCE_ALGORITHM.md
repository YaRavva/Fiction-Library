# Универсальный алгоритм релевантного поиска файлов для книг

## Описание

Универсальный алгоритм релевантного поиска, разработанный для сопоставления файлов с книгами по названию и автору. Алгоритм учитывает специфику имен файлов и заголовков книг, обеспечивая точное сопоставление даже при наличии разных вариантов написания и дополнительных элементов (годы, языковые обозначения и т.д.).

## Принципы работы

### 1. Нормализация строк
- Приведение к NFC нормализации Unicode
- Преобразование в нижний регистр
- Замена "ё" на "е"

### 2. Извлечение и очистка слов
- Разделение по всем возможным разделителям: пробелы, дефисы, скобки, точки, запятые, и другие специальные символы
- Удаление русских союзов (например: "и", "или", "а", "но", "в", "на", "не", "ни" и т.д.)
- Удаление дополнительных элементов: "цикл", "серия", "книга", "том", "издание", "ru", "en", "рус", "eng" и другие
- Удаление годов в скобках (например, "(2007)")
- Удаление языковых обозначений (например, "ru", "en")
- Удаление файловых расширений
- Удаление слов короче 2 символов

### 3. Алгоритм сопоставления
- Ищем точное совпадение каждого из слов, полученных из имени файла, с массивом слов, полученных из автора и названия книги
- Совпадением считается: только точное совпадение слов (например: "волк" и "волк" считается совпадением, но "волк" и "волкодав" - нет)
- Каждое совпадение дает 20 баллов
- Добавляется бонус за высокую долю совпадений (если 80% и более слов совпадают)
- Добавляется бонус за полное совпадение по автору и/или названию
- Применяются штрафы за лишние слова в файле, которые не встречаются в книге

### 4. Порог релевантности
- Минимальный порог: 65 баллов
- Файлы с оценкой ниже порога отбрасываются

### 5. Формат файла
- Формат файла не учитывается при оценке релевантности

### 6. MIME-типы
- Не фильтруются по MIME-типу

## Использование

### Для поиска подходящих файлов:
```typescript
import { UniversalFileMatcher } from '@/lib/universal-file-matcher';

const matchingFiles = UniversalFileMatcher.findMatchingFiles(book, allFiles);
```

### Для проверки релевантности конкретного файла:
```typescript
const isRelevant = UniversalFileMatcher.isFileRelevant(file, book);
```

### Для получения деталей сопоставления:
```typescript
const matchResult = UniversalFileMatcher.matchFileToBook(file, book);
console.log(`Оценка релевантности: ${matchResult.score}`);
console.log(`Совпавшие слова: ${matchResult.matchedWords.join(', ')}`);
```

## Примеры

### Пример 1: Точное совпадение
- Имя файла: "Станислав_Сергеев_Солдаты_Армегеддона.zip"
- Название книги: "Солдаты Армагеддона" 
- Автор: "Станислав Сергеев"
- Совпадения: "станислав", "сергеев", "солдаты", "армегеддона" (точные совпадения)
- Оценка: 4 совпадения × 20 = 80 баллов → Релевантный файл

### Пример 2: Совпадение с дополнительными элементами
- Имя файла: "Андреас_Эшбах_Выжжено.fb2"
- Название книги: "Андреас Эшбах - Выжжено (2007) (2008)"
- Совпадения: "андреас", "эшбах", "выжжено" (лишние "2007", "2008" игнорируются)
- Оценка: 3 совпадения × 20 + бонусы = 85+ баллов → Релевантный файл

## Принципы начисления баллов

- Совпадение слова из имени файла с любым словом из названия или автора: 20 баллов
- Совпадением считается только точное совпадение слов
- Бонус за высокую долю совпадений (80% и более): пропорционально соотношению
- Бонус за полное совпадение автора и названия: 25 баллов
- Бонус за частичное совпадение (автор ИЛИ название): 15 баллов
- Штраф за лишние слова в файле: 10 баллов за слово
- Штраф за несовпадающие слова: 5 баллов за слово
- Максимальная оценка: не ограничена

## Возвращаемые результаты

Функции возвращают:
- Для `findMatchingFiles`: массив файлов, релевантных книге (оценка >= 65), отсортированный по убыванию релевантности
- Для `matchFileToBook`: объект с оценкой, файлом и списком совпавших слов
- Для `isFileRelevant`: boolean значение (true, если оценка >= порога)