# Cursor Rules - Memory Bank Protocol для Fiction Library

## Система Memory Bank

Вы работаете с проектом Fiction Library, который использует методологию "Живая Документация". Ваша память между сессиями хранится в папке `.memory_bank/`. Эта система критически важна для поддержания контекста проекта.

## Обязательные Файлы Memory Bank

### Файлы для чтения в начале каждой сессии:
- `.memory_bank/activeContext.md` - текущие задачи и планы
- `.memory_bank/projectbrief.md` - цели и границы проекта  
- `.memory_bank/systemPatterns.md` - архитектурные паттерны (СТРОГО СЛЕДОВАТЬ)
- `.memory_bank/techContext.md` - технологический стек и ограничения
- `.memory_bank/progress.md` - статус задач и Git-синхронизация

## Триггеры Действий

### Когда пользователь говорит "начинаем" или "новая задача":
1. Прочитать `.memory_bank/activeContext.md`
2. Проверить Git-синхронизацию в `.memory_bank/progress.md`
3. Если хеши не совпадают - проанализировать изменения
4. Обновить план в `activeContext.md`

### Когда меняется архитектура или добавляются новые паттерны:
1. Обновить `.memory_bank/systemPatterns.md`
2. Использовать Mermaid диаграммы для визуализации
3. Документировать причины изменений

### При завершении задачи:
1. Обновить `.memory_bank/progress.md`
2. Очистить детали из `activeContext.md`
3. Обновить Git-хеш

## Ответственность по Файлам

### activeContext.md
- **Когда обновлять**: ПЕРВЫМ делом перед любым изменением кода
- **Что включать**: Текущий план, активные задачи, принятые решения
- **Формат**: Структурированный Markdown с чекбоксами для задач

### systemPatterns.md  
- **Когда обновлять**: При введении новых архитектурных решений
- **Что включать**: Диаграммы Mermaid, примеры кода, объяснения "почему"
- **Критично**: Все новый код ДОЛЖЕН следовать описанным паттернам

### techContext.md
- **Когда обновлять**: При добавлении новых зависимостей или изменении конфигурации
- **Что проверять**: Версии библиотек перед предложением импортов
- **Ограничения**: Использовать ТОЛЬКО технологии из этого файла

### progress.md
- **Когда обновлять**: После каждой завершенной задачи
- **Git-интеграция**: Обязательно обновлять хеш коммита
- **Статусы**: Использовать чекбоксы для отслеживания прогресса

## Специфика Fiction Library

### Архитектурные Принципы
- **Repository Pattern**: Для всех операций с данными
- **Queue Pattern**: Для асинхронных операций (загрузка файлов)
- **Service Layer**: Для бизнес-логики
- **Factory Pattern**: Для Telegram клиентов

### Технологический Стек (СТРОГО)
- **Frontend**: Next.js 15.5.9 + React 19 + TypeScript
- **UI**: shadcn/ui (nova style, stone base, amber accent) + Tailwind CSS 4.0
- **Font**: Comfortaa (Google Fonts, поддержка латиницы и кириллицы)
- **Database**: Supabase (PostgreSQL)
- **Storage**: Cloud.ru S3
- **Integration**: Telegram API (GramJS)

### Стандарты Кода
- **Именование файлов**: PascalCase для компонентов, camelCase для утилит
- **Структура**: Следовать паттерну из `systemPatterns.md`
- **TypeScript**: Строгий режим, избегать `any`
- **Обработка ошибок**: Структурированные JSON логи

## Рабочий Процесс

### 1. Начало работы
```typescript
// Всегда читать эти файлы первыми:
// 1. .memory_bank/activeContext.md
// 2. .memory_bank/progress.md (проверить Git-хеш)
// 3. .memory_bank/systemPatterns.md
```

### 2. Планирование
```typescript
// Обновить activeContext.md с планом:
// - Что делаем
// - Какие паттерны используем  
// - Ожидаемый результат
```

### 3. Реализация
```typescript
// Следовать паттернам из systemPatterns.md:
// - Repository для данных
// - Service для бизнес-логики
// - Правильная структура файлов
```

### 4. Завершение
```typescript
// Обновить документацию:
// - progress.md (статус + Git-хеш)
// - activeContext.md (очистить детали)
// - systemPatterns.md (если новые паттерны)
```

## Запрещенные Действия

❌ **НЕ создавать файлы документации вне `.memory_bank/`**
❌ **НЕ противоречить `projectbrief.md`**  
❌ **НЕ использовать технологии не из `techContext.md`**
❌ **НЕ писать код без обновления `activeContext.md`**
❌ **НЕ игнорировать паттерны из `systemPatterns.md`**

## Git-Интеграция

### Проверка синхронизации
```bash
# Получить текущий хеш
git log -1 --format="%H"

# Сравнить с хешем из progress.md
# Если различаются - выполнить:
git diff [старый_хеш] HEAD

# Проанализировать изменения и обновить Memory Bank
```

### Обновление после изменений
1. Прочитать `git diff` вывод
2. Определить затронутые области (UI, API, Database, etc.)
3. Обновить соответствующие разделы в Memory Bank
4. Обновить хеш в `progress.md`

## Примеры Команд

### Быстрое чтение контекста
```bash
# Активный контекст
cat .memory_bank/activeContext.md

# Текущие паттерны  
cat .memory_bank/systemPatterns.md

# Статус проекта
cat .memory_bank/progress.md
```

### Проектные команды
```bash
# Разработка
pnpm dev                    # Dev сервер
pnpm build                  # Сборка

# Telegram синхронизация
pnpm book-worm             # Основная синхронизация
pnpm book-worm:scheduled   # По расписанию

# Система очередей
pnpm worker                # Worker процесс
pnpm check-download-queue  # Статус очередей
```

## Интеграция с Cursor

### Использование с Composer
При работе с Cursor Composer:
1. Начинать каждый запрос с чтения Memory Bank
2. Включать контекст из `activeContext.md` в промпт
3. Ссылаться на паттерны из `systemPatterns.md`
4. Обновлять документацию после изменений

### Использование с Chat
При работе в Cursor Chat:
1. Упоминать файлы Memory Bank через `@`
2. Проверять соответствие техническим требованиям
3. Запрашивать обновление документации при необходимости

## Мониторинг Качества

### Проверки перед коммитом
- [ ] Код следует паттернам из `systemPatterns.md`
- [ ] Обновлен `activeContext.md` с текущим планом
- [ ] Обновлен `progress.md` со статусом
- [ ] Новые зависимости добавлены в `techContext.md`
- [ ] Git-хеш актуален в `progress.md`

### Метрики эффективности
- Время загрузки контекста: < 30 секунд
- Соответствие паттернам: 100%
- Актуальность документации: Синхронизация с каждым коммитом

Помните: Memory Bank - это ваша долговременная память. Поддерживайте её в актуальном состоянии!