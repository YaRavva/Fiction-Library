# Инструкция по синхронизации файлов из Telegram

## Обзор

Эта инструкция описывает, как использовать обновленную функциональность для синхронизации файлов из приватного канала "Архив для фантастики", загрузки их в бакет books и установки связи с книгами в БД.

**Примечание:** Подробная обновленная документация доступна в файле [TELEGRAM_SYNC_UPDATED.md](TELEGRAM_SYNC_UPDATED.md)

## Архитектура

1. **TelegramSyncService** - сервис для работы с Telegram API
2. **TelegramMetadataService** - сервис для синхронизации метаданных
3. **TelegramFileService** - сервис для обработки файлов
4. **Очередь загрузок** - таблица `telegram_download_queue` в БД
5. **BackgroundDownloadHandler** - фоновый обработчик для загрузки файлов
6. **BackgroundSyncHandler** - фоновый обработчик для синхронизации метаданных
7. **TaskManager** - менеджер задач для отслеживания прогресса
8. **API endpoints** - для управления процессом синхронизации

## Поля и их назначение

### В таблице `books`:
- **telegram_post_id** - ID сообщения из канала метаданных (публичный канал), содержащего информацию о книге
- **telegram_file_id** - ID сообщения из канала файлов (приватный канал), содержащего файл книги
- **storage_path** - путь к файлу в Supabase Storage

### В таблице `telegram_processed_messages`:
- **message_id** - ID сообщения из канала метаданных (публичный канал)
- **telegram_file_id** - ID сообщения из канала файлов (приватный канал), содержащего файл книги для данной книги
- **book_id** - ID книги в таблице books

## Улучшенная логика обработки

### Обработка дубликатов

Система теперь использует двухуровневую проверку дубликатов:
1. На этапе обработки сообщений - книги, которые уже существуют в БД, пропускаются сразу
2. На этапе импорта - дополнительная проверка на случай, если книга была добавлена между проверкой и импортом

### Обработка пустых значений

Система теперь корректно обрабатывает сообщения с отсутствующими названиями или авторами:
- Такие сообщения пропускаются с соответствующей причиной
- Улучшена обработка пустых имен файлов

### Улучшенные отчеты

Отчеты теперь корректно отображают:
- Общее количество пропущенных книг (включая те, что пропущены на этапе обработки сообщений)
- Понятные причины пропуска файлов
- Более детализированную статистику

## Асинхронная обработка с отслеживанием прогресса

Система теперь поддерживает асинхронную обработку как метаданных, так и файлов с отслеживанием прогресса:
- Запуск фоновых задач с уникальными ID
- Отслеживание прогресса через TaskManager
- Получение статуса и результатов по ID задачи

## Правильная последовательность действий при загрузке файлов

1. Получается имя файла из приватного канала
2. Сразу используется релевантный поиск книги в БД по имени файла
3. Если книга найдена с высокой степенью релевантности:
   - Проверяется, что для книги еще не загружен файл
   - Файл скачивается из приватного канала
   - Файл загружается в Supabase Storage (бакет books)
   - В таблице `telegram_processed_messages` в запись с соответствующим `book_id` заносится `telegram_file_id`
   - Файл привязывается к найденной книге в таблице `books`
4. Если книга не найдена или для книги уже есть запись о файле:
   - Файл пропускается даже без скачивания

## Использование

### 1. Синхронизация метаданных

#### Через API (рекомендуется):
```bash
# Синхронная синхронизация
curl -X POST http://localhost:3000/api/admin/sync \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"limit": 10}'

# Асинхронная синхронизация
curl -X POST http://localhost:3000/api/admin/sync-async \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"limit": 10}'

# Получение статуса асинхронной синхронизации
curl -X GET http://localhost:3000/api/admin/sync-async?operationId=YOUR_OPERATION_ID \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### Через скрипт:
```bash
# Синхронная синхронизация
npx tsx src/scripts/sync-books.ts [limit]

# Асинхронная синхронизация
npx tsx src/scripts/sync-books-async.ts [limit]
```

### 2. Синхронизация файлов

#### Через API (рекомендуется):
```bash
# Асинхронная загрузка файлов
curl -X POST http://localhost:3000/api/admin/download-files-async \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"limit": 50}'

# Получение статуса асинхронной загрузки
curl -X GET http://localhost:3000/api/admin/download-files-async?operationId=YOUR_OPERATION_ID \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### Через скрипт:
```bash
# Асинхронная загрузка файлов
npx tsx src/scripts/download-files-async.ts [limit]
```

### 3. Обработка отдельного файла

#### Через скрипт:
```bash
npx tsx src/scripts/download-single-file.ts <messageId>
```

Пример:
```bash
npx tsx src/scripts/download-single-file.ts 4379
```

## Возможные статусы выполнения

### Для файлов:
1. **Успешно** - файл загружен и привязан к книге
2. **Пропущен** - файл не был загружен по одной из причин:
   - `book_not_found` - книга не найдена в базе данных
   - `book_not_imported` - книга не импортирована из публичного канала
   - `already_processed` - файл уже был загружен ранее
   - `book_already_has_file` - для книги уже есть загруженный файл (в таблице telegram_processed_messages)
   - `book_already_has_file_in_books_table` - в таблице books уже есть запись с файлом
3. **Ошибка** - произошла ошибка при обработке файла

## Конфигурация

Убедитесь, что в .env файлах установлены следующие переменные:

```env
TELEGRAM_API_ID=your_api_id
TELEGRAM_API_HASH=your_api_hash
TELEGRAM_SESSION=your_session_string
TELEGRAM_METADATA_CHANNEL_ID=your_metadata_channel_id
TELEGRAM_FILES_CHANNEL_ID=your_files_channel_id
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

## Решение проблем

### Проблемы с доступом к каналу

1. Убедитесь, что вы являетесь участником канала "Архив для фантастики"
2. Проверьте правильность TELEGRAM_FILES_CHANNEL_ID
3. Запустите `npx tsx src/scripts/test-telegram-connection.ts` для проверки подключения

### Проблемы с загрузкой файлов

1. Проверьте логи фонового обработчика
2. Убедитесь, что у service role есть доступ к Supabase Storage
3. Проверьте, что бакет books существует и доступен

## Безопасность

- Все API endpoints защищены проверкой прав администратора
- Скрипты используют service role для доступа к Supabase
- Не храните чувствительные данные в логах