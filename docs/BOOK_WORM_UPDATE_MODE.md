# Режим обновления "Книжного червя"

## Обзор

Режим обновления ("update mode") - это режим синхронизации, при котором обрабатываются только новые сообщения из Telegram-канала, начиная с последнего обработанного сообщения. Основная цель этого режима - обновление данных о книгах без перепроцессинга всей коллекции.

## Правильная логика работы в режиме обновления

### 1. Определение необходимости обработки

- Система должна получить ID последнего обработанного сообщения из базы данных
- Загрузить только сообщения с ID **выше** последнего обработанного
- Если в канале нет сообщений с ID выше последнего обработанного, ничего делать не нужно

### 2. Алгоритм обработки новых сообщений

При обнаружении новых сообщений система должна выполнить следующие шаги:

1. **Проверка валидности сообщения**
   - Проверить, что сообщение содержит текст
   - Использовать `MetadataParser.parseMessage()` для извлечения метаданных
   - Проверить, что у книги есть название и автор (обязательные поля)
   - Если не проходит валидацию - пометить как обработанное и перейти к следующему

2. **Проверка уникальности**
   - Проверить, существует ли уже книга с такими же названием и автором в базе данных
   - Использовать обновленный алгоритм дедупликации для исключения дубликатов
   - Если книга уже существует - пометить сообщение как обработанное и перейти к следующему

3. **Загрузка в БД**
   - Сохранить валидные метаданные книги в таблицу `books`
   - Привязать ID сообщения к записи книги

4. **Обработка обложки**
   - Проверить наличие медиа-файлов в сообщении
   - Извлечь обложку из веб-превью или фото в сообщении
   - Загрузить обложку в S3-хранилище
   - Сохранить URL обложки в записи книги

5. **Поиск и привязка файла книги**
   - Загрузить список файлов из Telegram
   - Запустить универсальный алгоритм привязки файлов к книгам
   - Для найденных совпадений выполнить привязку (processSingleFileById)
   - Обновить статус обработки сообщения в таблице `telegram_processed_messages`

### 3. Обработка ситуации без новых сообщений

Если новых сообщений нет:
- Записать в лог информацию о том, что новых сообщений не обнаружено
- Завершить работу без выполнения дополнительной обработки
- Вернуть соответствующий статус выполнения

## Отличия от полной синхронизации

| Характеристика | Режим обновления | Полная синхронизация |
|----------------|------------------|----------------------|
| Обрабатываемые сообщения | Только новые (с ID выше последнего обработанного) | Все сообщения из канала |
| Цель | Обновление новых данных | Проверка целостности всей коллекции |
| Частота запуска | Регулярно | Периодически при необходимости |
| Ресурсоемкость | Низкая | Высокая |

## Использование

### Запуск в режиме обновления

```bash
# Запуск через API endpoint
POST /api/admin/book-worm
Body: { "mode": "update" }

# Запуск через скрипт
npx tsx src/scripts/run-book-worm.ts --mode update
```

## Логирование

Во время выполнения режима обновления выводится подробная информация:

- ID последнего обработанного сообщения
- Количество новых сообщений для обработки
- Статистика по добавленным/обновленным книгам
- Статистика по привязанным файлам
- Статистика по пропущенным/ошибочным сообщениям

## Особенности реализации

1. **Эффективная загрузка сообщений**
   - Использовать offsetId для получения только новых сообщений
   - Минимизировать количество запросов к Telegram API

2. **Корректная обработка ID**
   - Обрабатывать только сообщения с ID, строго больше последнего обработанного
   - Обеспечивать отсутствие пропусков или дубликатов

3. **Обработка ошибок**
   - Все ошибки логируются с подробной информацией
   - Выполнение продолжается даже при возникновении отдельных ошибок

4. **Дедупликация данных**
   - Проверяет существование книг в базе данных перед импортом
   - Предотвращает создание дубликатов записей