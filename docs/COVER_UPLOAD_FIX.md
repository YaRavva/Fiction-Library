# üñºÔ∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–µ–∫ –∏–∑ Telegram

## –ü—Ä–æ–±–ª–µ–º–∞

–û–±–ª–æ–∂–∫–∏ –∫–Ω–∏–≥ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –∏–∑ Telegram –≤ Supabase Storage bucket "covers", —Ö–æ—Ç—è bucket –±—ã–ª —Å–æ–∑–¥–∞–Ω –∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.

## –ü—Ä–∏—á–∏–Ω—ã

1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –º–µ–¥–∏–∞**: –û–±–ª–æ–∂–∫–∏ –≤ Telegram –∫–∞–Ω–∞–ª–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ `MessageMediaWebPage` (–≤–µ–±-–ø—Ä–µ–≤—å—é), –∞ –Ω–µ –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ —Ñ–æ—Ç–æ (`MessageMediaPhoto`)
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤–µ–±-–ø—Ä–µ–≤—å—é**: –ö–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–ª —Ç–æ–ª—å–∫–æ `media.photo`, –Ω–æ –Ω–µ `media.webpage.photo`
3. **–ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π Supabase Admin –∫–ª–∏–µ–Ω—Ç–∞**: –ö–ª–∏–µ–Ω—Ç —Å `SERVICE_ROLE_KEY` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

## –†–µ—à–µ–Ω–∏–µ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä—Å–µ—Ä –º–µ–¥–∏–∞ –≤ `src/lib/telegram/sync.ts`

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `MessageMediaWebPage`:

```typescript
// –ï—Å–ª–∏ —ç—Ç–æ –≤–µ–±-–ø—Ä–µ–≤—å—é (MessageMediaWebPage) - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª—É—á–∞–π –¥–ª—è –æ–±–ª–æ–∂–µ–∫
if (anyMsg.media.className === 'MessageMediaWebPage' && anyMsg.media.webpage?.photo) {
    console.log(`  ‚Üí –í–µ–±-–ø—Ä–µ–≤—å—é —Å —Ñ–æ—Ç–æ`);
    const photoBuffer = await this.telegramClient.downloadMedia(anyMsg.media.webpage.photo);
    // ... –∑–∞–≥—Ä—É–∑–∫–∞ –≤ Storage
}
```

### 2. –£–ª—É—á—à–µ–Ω –º–µ—Ç–æ–¥ `downloadMedia` –≤ `src/lib/telegram/client.ts`

–¢–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –ª—é–±—ã—Ö –º–µ–¥–∏–∞-–æ–±—ä–µ–∫—Ç–æ–≤:

```typescript
public async downloadMedia(messageOrMedia: any) {
    // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç Photo (–∏–∑ –≤–µ–±-–ø—Ä–µ–≤—å—é –∏–ª–∏ –∞–ª—å–±–æ–º–∞)
    if (messageOrMedia.className === 'Photo') {
        return await this.client.downloadMedia(messageOrMedia);
    }
    // ... –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã –º–µ–¥–∏–∞
}
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase Admin –≤ `src/lib/supabase.ts`

–°–¥–µ–ª–∞–Ω–∞ –ª–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞:

```typescript
export const getSupabaseAdmin = () => {
  if (!_supabaseAdmin) {
    // –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const key = process.env.SUPABASE_SERVICE_ROLE_KEY;
    
    if (url && key) {
      _supabaseAdmin = createSupabaseClient(url, key, {
        auth: {
          autoRefreshToken: false,
          persistSession: false
        }
      });
    }
  }
  return _supabaseAdmin;
};
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—ã–≤–æ–¥–∏—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
- –¢–∏–ø –º–µ–¥–∏–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
- –ü—Ä–æ—Ü–µ—Å—Å —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ
- –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Storage
- URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –æ–±–ª–æ–∂–∫–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `src/scripts/test-cover-upload.ts` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–µ–∫:

```bash
npx tsx src/scripts/test-cover-upload.ts
```

### –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω—Å–ø–µ–∫—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `src/scripts/inspect-telegram-message.ts` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π:

```bash
npx tsx src/scripts/inspect-telegram-message.ts
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

‚úÖ **–û–±–ª–æ–∂–∫–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è!**

- –í—Å–µ –æ–±–ª–æ–∂–∫–∏ –∏–∑ –≤–µ–±-–ø—Ä–µ–≤—å—é –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –∏–∑ Telegram
- –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Supabase Storage bucket "covers"
- URL –æ–±–ª–æ–∂–µ–∫ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–æ–ª–µ `cover_url` —Ç–∞–±–ª–∏—Ü `books` –∏ `series`

### –ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

```
üì∏ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –º–µ–¥–∏–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ 4918 (—Ç–∏–ø: MessageMediaWebPage)
  ‚Üí –í–µ–±-–ø—Ä–µ–≤—å—é —Å —Ñ–æ—Ç–æ
  ‚Üí –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ –∏–∑ –≤–µ–±-–ø—Ä–µ–≤—å—é...
  ‚Üí –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ Storage: covers/4918_1759422797326.jpg
  ‚úÖ –û–±–ª–æ–∂–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: https://ygqyswivvdtpgpnxrpzl.supabase.co/storage/v1/object/public/covers/4918_1759422797326.jpg
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–¥–∏–∞ –≤ Telegram

–û–±–ª–æ–∂–∫–∏ –≤ –∫–∞–Ω–∞–ª–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ –≤–µ–±-–ø—Ä–µ–≤—å—é:

```javascript
{
  className: 'MessageMediaWebPage',
  webpage: {
    className: 'WebPage',
    url: 'https://telegra.ph/file/8755c6d4b934b286c82ef.jpg',
    type: 'photo',
    photo: {
      className: 'Photo',
      id: ...,
      sizes: [...]
    }
  }
}
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–±–ª–æ–∂–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
3. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞ (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `src/lib/telegram/sync.ts` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `src/lib/telegram/client.ts` - Telegram –∫–ª–∏–µ–Ω—Ç
- `src/lib/supabase.ts` - Supabase –∫–ª–∏–µ–Ω—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã
- `src/scripts/test-cover-upload.ts` - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- `src/scripts/inspect-telegram-message.ts` - —Å–∫—Ä–∏–ø—Ç –∏–Ω—Å–ø–µ–∫—Ü–∏–∏
- `docs/MIGRATION_006_COVERS.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Storage

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

2 –æ–∫—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞

