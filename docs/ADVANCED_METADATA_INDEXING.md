# Расширенная индексация метаданных

## Обзор

Расширенная индексация метаданных - это новый метод обработки сообщений Telegram, который позволяет более эффективно индексировать, искать и анализировать метаданные книг.

## Особенности

### 1. Расширенная индексация сообщений

Новый метод индексации сохраняет следующую информацию о каждом сообщении:

- **message_id**: Уникальный идентификатор сообщения
- **channel**: Идентификатор канала
- **author**: Автор книги (извлеченный из сообщения)
- **title**: Название книги (извлеченное из сообщения)
- **updated_at**: Дата и время последнего обновления

Важно понимать, что таблица `telegram_messages_index` используется только для отслеживания наличия новых сообщений в Telegram, а не для хранения полных метаданных. Полные метаданные хранятся в таблице `books`.

### 2. Поиск по ключевым словам

Метод поиска позволяет находить сообщения по ключевым словам в следующих полях:

- Автор книги
- Название книги

Результаты поиска ранжируются по релевантности с учетом весов:
- Точное совпадение по названию: вес 5
- Точное совпадение по автору: вес 3

### 3. Статистика индекса

Метод получения статистики предоставляет информацию о качестве индексированных данных:

- Общее количество сообщений
- Количество сообщений с автором
- Количество сообщений с названием

## Использование

### Запуск расширенной индексации

```bash
# Запуск через основной скрипт
npx tsx src/scripts/run-book-worm.ts index

# Запуск демонстрационного скрипта
npx tsx src/scripts/advanced-metadata-indexing.ts

# Запуск тестового скрипта
npx tsx src/scripts/test-advanced-indexing.ts
```

### Программное использование

```typescript
import { BookWormService } from '../lib/telegram/book-worm-service';

const bookWorm = new BookWormService();

// Расширенная индексация
await bookWorm.advancedIndexMessages(100); // 100 сообщений за раз

// Поиск по ключевым словам
const results = await bookWorm.searchMessages(['фантастика', 'автор'], 10);

// Получение статистики
const stats = await bookWorm.getIndexStatistics();
```

## Преимущества

1. **Более эффективная индексация**: Улучшенный алгоритм индексации сообщений
2. **Эффективный поиск**: Поиск по полям автора и названия с ранжированием
3. **Анализ качества данных**: Статистика помогает оценить полноту индексированных данных
4. **Правильное разделение ответственности**: Таблица `telegram_messages_index` используется только для отслеживания новых сообщений

## Технические детали

### Структура таблицы индекса

Таблица `telegram_messages_index` имеет следующую структуру:

```sql
CREATE TABLE telegram_messages_index (
    message_id BIGINT PRIMARY KEY,
    channel TEXT,
    author TEXT,
    title TEXT,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

Эта таблица используется только для отслеживания наличия новых сообщений в Telegram. Полные метаданные книг хранятся в таблице `books`.

### Алгоритм поиска

Алгоритм поиска работает следующим образом:

1. Формируются условия поиска для каждого ключевого слова
2. Выполняется запрос к базе данных с использованием оператора OR
3. Для каждого результата вычисляется коэффициент релевантности
4. Результаты сортируются по убыванию релевантности
5. Возвращаются топ-N результатов

## Примеры использования

### Поиск книг по автору или названию

```bash
npx tsx src/scripts/run-book-worm.ts index
```

После индексации можно искать книги:

```typescript
const results = await bookWorm.searchMessages(['Толкин'], 20);
```

### Анализ качества индекса

```typescript
const stats = await bookWorm.getIndexStatistics();
console.log(`Проиндексировано ${stats.totalMessages} сообщений`);
console.log(`${stats.messagesWithAuthor} имеют информацию об авторе`);
console.log(`${stats.messagesWithTitle} имеют название`);
```

## Планирование

Расширенная индексация может выполняться по расписанию для поддержания актуальности данных:

```bash
# Ежедневная индексация в 2:00
0 2 * * * npx tsx src/scripts/run-book-worm.ts index
```