# Система обработки файлов из Telegram

## Обзор

Система обработки файлов из Telegram предназначена для автоматического сопоставления, загрузки и привязки файлов книг из приватного канала "Архив для фантастики" к записям в базе данных.

## Архитектура системы

### 1. Получение файлов

Система подключается к Telegram-каналу "Архив для фантастики" (ID: 1515159552) и получает список доступных файлов.

**Ключевые компоненты:**
- `TelegramService` - управление подключением к Telegram
- `TelegramFileService` - обработка файлов
- `TelegramMetadataService` - синхронизация метаданных

### 2. Релевантный поиск

Алгоритм релевантного поиска сопоставляет файлы с книгами в базе данных.

**См. подробнее:** [Алгоритм релевантного поиска](RELEVANT_SEARCH_ALGORITHM.md)

### 3. Загрузка и хранение

Файлы загружаются из Telegram и сохраняются в хранилище Supabase.

### 4. Привязка к базе данных

Файлы привязываются к соответствующим записям книг в базе данных.

## Процесс обработки

### Этап 1: Получение списка файлов
1. Подключение к каналу "Архив для фантастики"
2. Получение последних сообщений с файлами
3. Извлечение метаданных файлов

### Этап 2: Сопоставление с книгами
1. Извлечение поисковых терминов из имен файлов
2. Поиск совпадений в базе данных
3. Расчет оценок релевантности
4. Выбор лучшего совпадения

### Этап 3: Проверка дубликатов
1. Проверка, что для книги еще не загружен файл
2. Пропуск файлов, которые уже существуют

### Этап 4: Загрузка файлов
1. Скачивание файла из Telegram
2. Загрузка файла в хранилище Supabase
3. Генерация публичного URL файла

### Этап 5: Обновление базы данных
1. Обновление записи книги информацией о файле
2. Сохранение URL, размера и формата файла
3. Запись информации в таблицу telegram_processed_messages

## Улучшенная логика обработки

### Обработка дубликатов

Система теперь использует двухуровневую проверку дубликатов:
1. На этапе обработки сообщений - книги, которые уже существуют в БД, пропускаются сразу
2. На этапе импорта - дополнительная проверка на случай, если книга была добавлена между проверкой и импортом

### Обработка пустых значений

Система теперь корректно обрабатывает сообщения с отсутствующими названиями или авторами:
- Такие сообщения пропускаются с соответствующей причиной
- Улучшена обработка пустых имен файлов

### Улучшенные отчеты

Отчеты теперь корректно отображают:
- Общее количество пропущенных книг (включая те, что пропущены на этапе обработки сообщений)
- Понятные причины пропуска файлов
- Более детализированную статистику

## Возможные статусы выполнения

### Для файлов:
1. **Успешно** - файл загружен и привязан к книге
2. **Пропущен** - файл не был загружен по одной из причин:
   - `book_not_found` - книга не найдена в базе данных
   - `book_not_imported` - книга не импортирована из публичного канала
   - `already_processed` - файл уже был загружен ранее
   - `book_already_has_file` - для книги уже есть загруженный файл (в таблице telegram_processed_messages)
   - `book_already_has_file_in_books_table` - в таблице books уже есть запись с файлом
3. **Ошибка** - произошла ошибка при обработке файла

## Тестирование

Система была тщательно протестирована с использованием различных сценариев.

**См. подробнее:** [Тестовые скрипты](TEST_SCRIPTS.md)

## Результаты

### Статистика тестирования:
- **Успешных сопоставлений:** 100%
- **Высокодостоверных совпадений:** 50-100% (в зависимости от набора файлов)
- **Обработанных файлов:** 20+ в тестах
- **Сопоставленных книг:** 468 (полная база данных)

### Примеры успешных сопоставлений:
- "Иван Шаман - Паутина миров.zip" → "цикл Паутина миров" (оценка: 28)
- "Роберт_Силверберг_Ночные_крылья.fb2" → "Ночные крылья (1969)" (оценка: 28)
- "Джон Уиндем - Зайцем на Марс.zip" → "цикл Зайцем на Марс" (оценка: 18)

## Интеграция

Система готова к интеграции в основное приложение и может использоваться для:
- Автоматической обработки новых файлов
- Массовой привязки существующих файлов
- Регулярной синхронизации с каналом

## Будущие улучшения

1. **Оптимизация производительности** для работы с большими объемами данных
2. **Улучшенная обработка неоднозначностей** при сопоставлении
3. **Интеграция с пользовательским интерфейсом** для ручного подтверждения сопоставлений
4. **Автоматическое обновление** при появлении новых файлов в канале