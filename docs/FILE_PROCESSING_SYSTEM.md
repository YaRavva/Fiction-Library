# Система обработки файлов из Telegram

## Обзор

Система обработки файлов из Telegram предназначена для автоматического сопоставления, загрузки и привязки файлов книг из приватного канала "Архив для фантастики" к записям в базе данных.

## Архитектура системы

### 1. Получение файлов

Система подключается к Telegram-каналу "Архив для фантастики" (ID: 1515159552) и получает список доступных файлов.

**Ключевые компоненты:**
- `TelegramService` - управление подключением к Telegram
- `TelegramSyncService` - синхронизация файлов

### 2. Релевантный поиск

Алгоритм релевантного поиска сопоставляет файлы с книгами в базе данных.

**См. подробнее:** [Алгоритм релевантного поиска](RELEVANT_SEARCH_ALGORITHM.md)

### 3. Загрузка и хранение

Файлы загружаются из Telegram и сохраняются в хранилище Supabase.

### 4. Привязка к базе данных

Файлы привязываются к соответствующим записям книг в базе данных.

## Процесс обработки

### Этап 1: Получение списка файлов
1. Подключение к каналу "Архив для фантастики"
2. Получение последних сообщений с файлами
3. Извлечение метаданных файлов

### Этап 2: Сопоставление с книгами
1. Извлечение поисковых терминов из имен файлов
2. Поиск совпадений в базе данных
3. Расчет оценок релевантности
4. Выбор лучшего совпадения

### Этап 3: Загрузка файлов
1. Скачивание файла из Telegram
2. Загрузка файла в хранилище Supabase
3. Генерация публичного URL файла

### Этап 4: Обновление базы данных
1. Обновление записи книги информацией о файле
2. Сохранение URL, размера и формата файла

## Тестирование

Система была тщательно протестирована с использованием различных сценариев.

**См. подробнее:** [Тестовые скрипты](TEST_SCRIPTS.md)

## Результаты

### Статистика тестирования:
- **Успешных сопоставлений:** 100%
- **Высокодостоверных совпадений:** 50-100% (в зависимости от набора файлов)
- **Обработанных файлов:** 20+ в тестах
- **Сопоставленных книг:** 468 (полная база данных)

### Примеры успешных сопоставлений:
- "Иван Шаман - Паутина миров.zip" → "цикл Паутина миров" (оценка: 28)
- "Роберт_Силверберг_Ночные_крылья.fb2" → "Ночные крылья (1969)" (оценка: 28)
- "Джон Уиндем - Зайцем на Марс.zip" → "цикл Зайцем на Марс" (оценка: 18)

## Интеграция

Система готова к интеграции в основное приложение и может использоваться для:
- Автоматической обработки новых файлов
- Массовой привязки существующих файлов
- Регулярной синхронизации с каналом

## Будущие улучшения

1. **Оптимизация производительности** для работы с большими объемами данных
2. **Улучшенная обработка неоднозначностей** при сопоставлении
3. **Интеграция с пользовательским интерфейсом** для ручного подтверждения сопоставлений
4. **Автоматическое обновление** при появлении новых файлов в канале