# Лемма - Универсальный алгоритм релевантного поиска файлов для книг

## Общее описание

Универсальный алгоритм релевантного поиска файлов для книг (далее - "алгоритм") предназначен для сопоставления файлов из Telegram-канала с книгами в базе данных. Алгоритм использует комплексный подход к анализу и сравнению строк названий и авторов, применяя морфологический анализ, нормализацию и систему весов для определения степени релевантности.

## Основные правила

1. **Нормализация**: NFC нормализация, нижний регистр, "ё" → "е"
2. **Разбиение слов**: все возможные варианты, союзы и слово "цикл" отбрасываются
3. **Алгоритм поиска**: ищем совпадение каждого из слов, полученных из имени файла, с массивом слов, полученных из автора и названия книги
4. **Морфологический анализ**: слова приводятся к нормальной (начальной) форме
5. **Игнорирование метаданных**: года и обозначения языков игнорируются при сравнении
6. **Исключаемые элементы**: союзы, форматы файлов, общие слова и т.д.

## Список исключений

### Союзы:
- и, или, а, но, да, же, ли, бы, б, в, во, на, над, под, при, через, с, со, у, о, об, от, до, за, из, к, ко, по, не, ни, же

### Дополнительные элементы:
- цикл, серия, серий, книга, том, тома, собрание, издание, издательство
- ru, en, рус, eng, язык, перевод, автор, редакция, иллюстрации
- zip, fb2
- ле, де, ла, и, соавт, with, да, не

## Алгоритм сопоставления

### 1. Извлечение слов

1. Удаляем расширение файла
2. Удаляем года в скобках
3. Удаляем языковые обозначения
4. Удаляем эмодзи
5. Нормализуем строку
6. Разбиваем на слова по разделителям: пробелы, дефисы, скобки, точки, запятые и др.
7. Убираем слова короче 2 символов
8. Убираем союзы и дополнительные элементы
9. Применяем морфологический анализ (лемматизацию)

### 2. Основные сопоставления

1. **Базовая оценка**: 20 баллов за каждое совпадение слова
   - Совпавшее слово из файла = Совпавшее слово из книги

2. **Бонус за совпадение 2+ слов в названии**: 12 баллов за каждое слово
3. **Бонус за одно слово в названии**: 8 баллов
4. **Дополнительный бонус за точное совпадение автора**:
   - Если авторы полностью совпадают и есть 1+ слово в названии: +20 баллов
   - Если авторы полностью совпадают и есть 2+ слов в названии: +15 баллов
   - Увеличенный бонус: 15 баллов за каждое совпавшее слово в названии

### 3. Ограничения оценок

1. **Совпадение только по автору (без названия)**: максимум 40 баллов
2. **Совпадение только по названию (без автора)**: максимум 70 баллов
3. **Совпадение по автору + 1 слово в названии**: максимум 80 баллов
4. **Совпадение по автору + 2+ слов в названии**: без ограничений

### 4. Штрафы

1. **За лишние слова в файле**: 3 балла за слово (уменьшается до 0 при полном совпадении автора)
2. **Пропорциональный штраф за несовпадения**: 1 балл за несовпадение (уменьшается до 0 при полном совпадении автора)
3. **Штраф за несовпадение авторов**:
   - Если нет совпадений по автору, но есть по названию: -20 баллов
   - Если частичное совпадение по автору, но имена разные: ограничение до 30 баллов

### 5. Специальные бонусы

1. **Корректирующий бонус**: если авторы совпадают, есть совпадения в названии, но оценка < 65, добавляется бонус до 70 баллов
2. **Бонус за высокую долю совпадений**:
   - Если 60% и более слов совпадают: бонус 15 * коэффициент_совпадения * 3
   - Если 70% и более слов из книги найдены: бонус 10 * коэффициент_совпадения * 2

## Специфическая логика

### Обработка частичных совпадений

1. Если полные имена авторов совпадают, но есть лишние слова в названии, штрафы снижаются
2. Если имена авторов не совпадают, но есть частичное совпадение, максимальная оценка ограничивается до 30 баллов
3. Для разных авторов без совпадений по названию: максимальный штраф 40 баллов

### Обработка специфических случаев

1. Если названия содержат ключевые слова "гаррет", "барлион", добавляется бонус 30 баллов
2. Для несовпадений по теме (например, "барлион" vs "изменённый мир"): штраф 25-35 баллов

## Порог релевантности

- Порог для релевантности: 65 баллов
- Результаты с оценкой ≥ 65 считаются подходящими для привязки
- Результаты с оценкой < 65 считаются несоответствующими

# Методика тестирования

## Цель тестирования

Проверить корректность работы обновленного алгоритма сопоставления файлов и книг, оценить точность и полноту сопоставлений, выявить ошибки и области для улучшения.

## Методика

### 1. Загрузка данных

1. Загрузка 2000 файлов из Telegram-канала (батчами по 1000)
2. Загрузка всех книг без файлов из базы данных
3. Использование метода `getFilesToProcess` с параметром offsetId для постраничной загрузки

### 2. Сопоставление

1. Для каждой книги ищется наиболее подходящий файл из всех загруженных
2. Используется метод `matchFileToBook` для расчета оценки релевантности
3. Рассчитываются совпадения по автору и названию

### 3. Вывод результатов

1. Сортировка всех сопоставлений по оценке
2. Вывод 10 результатов с оценкой ближайшей к порогу 65 (но < 65) - "ниже порога"
3. Вывод 10 результатов с оценкой ближайшей к порогу 65 (но ≥ 65) - "выше порога"
4. Предоставление информации о файле, книге и оценке

## Критерии оценки

### Точность (Precision)
- Доля правильно сопоставленных файлов среди всех сопоставлений с оценкой ≥ 65

### Полнота (Recall)
- Доля файлов, которые должны были быть сопоставлены, и были корректно сопоставлены

### F-мера
- Комбинированная метрика: F1 = 2 * (Precision * Recall) / (Precision + Recall)

## Оценка результатов

1. Ручная проверка результатов из обеих групп (выше и ниже порога)
2. Оценка, насколько логичны сопоставления
3. Выявление случаев, когда:
   - Верное сопоставление получило оценку < 65 (ошибка пропуска)
   - Неверное сопоставление получило оценку ≥ 65 (ошибка ложного срабатывания)

## Повторяемость теста

Тест должен быть воспроизводимым:
- Использование одних и тех же данных
- Повторный запуск должен давать схожие результаты
- Возможность тестирования после внесения изменений в алгоритм