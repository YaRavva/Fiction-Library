# Документация по интеграции Telegram

## Сопоставление полей каналов Telegram

### Сопоставление полей каналов Telegram

1. **telegram_post_id** в таблице `books` и **message_id** в таблице `telegram_processed_messages`
   - Оба представляют ID сообщения из **канала метаданных**
   - Это сообщение содержит метаданные книги (название, автор, описание и т.д.)

2. **telegram_file_id** в таблице `telegram_processed_messages`
   - Представляет ID сообщения с файлом книги из **приватного канала файлов**
   - Это сообщение содержит сам файл книги (FB2, ZIP и т.д.)

## Правильная последовательность обработки

Правильная последовательность операций при загрузке файлов следующая:

1. **Получается имя файла из приватного канала**
   - Извлекается имя файла из сообщения в приватном канале файлов

2. **Проверяется наличие записи в telegram_processed_messages**
   - Записи должны создаваться только при синхронизации метаданных из публичного канала
   - Если записи нет, значит книга не была импортирована и файл не нужен

3. **Проверяется наличие записи о файле в telegram_processed_messages**
   - Если для книги уже существует запись с telegram_file_id, значит файл уже обработан и связи установлены
   - В этом случае файл пропускается

4. **Проверяется наличие записи в таблице books**
   - Если в таблице books для этой книги уже заполнено поле telegram_file_id, файл уже был привязан
   - В этом случае файл также пропускается

5. **Если все проверки пройдены**
   - Файл скачивается
   - Загружается в бакет Supabase Storage
   - Обновляется запись в таблице books
   - Обновляется запись в таблице telegram_processed_messages с telegram_file_id

6. **Если книга не найдена или для книги уже есть файл**
   - Файл пропускается даже без скачивания

## Архитектура сервисов

Интеграция Telegram теперь разделена на два отдельных сервиса для повышения производительности:

1. **TelegramMetadataService** (`metadata-service.ts`)
   - Обрабатывает синхронизацию метаданных из публичного канала
   - Обрабатывает информацию о книгах и создает записи в базе данных

2. **TelegramFileService** (`file-service.ts`)
   - Обрабатывает загрузку файлов из приватного канала
   - Привязывает файлы к существующим записям книг
   - Управляет хранением файлов в Supabase

## Система очередей и воркеров

Для более эффективной обработки файлов реализована система очередей и воркеров:

1. **Очередь загрузок** (`telegram_download_queue`)
   - Хранит задачи на загрузку файлов
   - Поддерживает статусы: pending, processing, completed, failed
   - Позволяет управлять приоритетами задач

2. **Воркер загрузок** (`download-worker.ts`)
   - Обрабатывает задачи из очереди
   - Может быть запущен как отдельный процесс
   - Поддерживает автоматическую повторную попытку при ошибках

3. **Управление через API**
   - `/api/admin/worker` - управление воркером (запуск, остановка, статус)

4. **Скрипты командной строки**
   - `npm run start-download-worker` - запуск воркера
   - `npm run check-download-queue` - проверка статуса очереди
   - `npm run add-to-download-queue` - добавление задачи в очередь

## Алгоритм поиска книг по именам файлов

При обработке файлов система использует улучшенный алгоритм поиска книг:

1. **Извлечение метаданных**
   - Имя файла разбивается на слова
   - Определяются автор и название книги

2. **Поиск по терминам**
   - Каждое слово из имени файла используется как поисковый термин
   - Поиск осуществляется как по названию, так и по автору

3. **Ранжирование результатов**
   - Результаты ранжируются по релевантности
   - Учитываются совпадения по извлеченным метаданным и поисковым терминам

4. **Выбор лучшего совпадения**
   - Из всех найденных совпадений выбирается наиболее релевантное