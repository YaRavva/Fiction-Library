# Документация по интеграции Telegram

## Сопоставление полей каналов Telegram

### Сопоставление полей каналов Telegram

1. **telegram_post_id** в таблице `books` и **message_id** в таблице `telegram_processed_messages`
   - Оба представляют ID сообщения из **канала метаданных**
   - Это сообщение содержит метаданные книги (название, автор, описание и т.д.)

2. **telegram_file_id** в таблице `telegram_processed_messages`
   - Представляет ID сообщения с файлом книги из **приватного канала файлов**
   - Это сообщение содержит сам файл книги (FB2, ZIP и т.д.)

## Правильная последовательность обработки

Правильная последовательность операций при загрузке файлов следующая:

1. **Получается имя файла из приватного канала**
   - Извлекается имя файла из сообщения в приватном канале файлов

2. **Проверяется наличие записи в telegram_processed_messages**
   - Записи должны создаваться только при синхронизации метаданных из публичного канала
   - Если записи нет, значит книга не была импортирована и файл не нужен

3. **Проверяется наличие записи о файле в telegram_processed_messages**
   - Если для книги уже существует запись с telegram_file_id, значит файл уже обработан и связи установлены
   - В этом случае файл пропускается

4. **Проверяется наличие записи в таблице books**
   - Если в таблице books для этой книги уже заполнено поле telegram_file_id, файл уже был привязан
   - В этом случае файл также пропускается

5. **Если все проверки пройдены**
   - Файл скачивается
   - Загружается в бакет Supabase Storage
   - Обновляется запись в таблице books
   - Обновляется запись в таблице telegram_processed_messages с telegram_file_id

6. **Если книга не найдена или для книги уже есть файл**
   - Файл пропускается даже без скачивания

## Архитектура сервисов

Интеграция Telegram теперь разделена на несколько сервисов для повышения производительности:

1. **TelegramMetadataService** (`metadata-service.ts`)
   - Обрабатывает синхронизацию метаданных из публичного канала
   - Обрабатывает информацию о книгах и создает записи в базе данных

2. **TelegramFileService** (`file-service.ts`)
   - Обрабатывает загрузку файлов из приватного канала
   - Привязывает файлы к существующим записям книг
   - Управляет хранением файлов в Supabase

3. **BookWormService** (`book-worm-service.ts`)
   - Основной сервис синхронизации ("Книжный Червь")
   - Объединяет функции синхронизации метаданных и файлов
   - Реализует интеллектуальный алгоритм сопоставления книг и файлов

## Система очередей и воркеров

Для более эффективной обработки файлов реализована система очередей и воркеров:

1. **Очередь загрузок** (`telegram_download_queue`)
   - Хранит задачи на загрузку файлов
   - Поддерживает статусы: pending, processing, completed, failed
   - Позволяет управлять приоритетами задач

2. **Воркер загрузок** (`download-worker.ts`)
   - Обрабатывает задачи из очереди
   - Может быть запущен как отдельный процесс
   - Поддерживает автоматическую повторную попытку при ошибках

3. **Управление через API**
   - `/api/admin/worker` - управление воркером (запуск, остановка, статус)

4. **Скрипты командной строки**
   - `npm run start-download-worker` - запуск воркера
   - `npm run check-download-queue` - проверка статуса очереди
   - `npm run add-to-download-queue` - добавление задачи в очередь

## Алгоритм поиска книг по именам файлов

При обработке файлов система использует улучшенный алгоритм поиска книг:

1. **Извлечение метаданных**
   - Имя файла разбивается на слова
   - Определяются автор и название книги

2. **Поиск по терминам**
   - Каждое слово из имени файла используется как поисковый термин
   - Поиск осуществляется как по названию, так и по автору

3. **Ранжирование результатов**
   - Результаты ранжируются по релевантности
   - Учитываются совпадения по извлеченным метаданным и поисковым терминам
   - Применяется система штрафов за ложные совпадения

4. **Выбор лучшего совпадения**
   - Из всех найденных совпадений выбирается наиболее релевантное
   - Минимальный порог релевантности: 30 очков

## "Книжный Червь" - основной сервис синхронизации

### Режимы работы:
1. **Режим обновления (update mode)** - обработка только новых сообщений с ID выше последнего обработанного
2. **Полная синхронизация (full mode)** - проверка целостности всей коллекции

### Логика работы в режиме обновления:
1. Получает ID последнего обработанного сообщения из базы данных
2. Загружает только сообщения с ID **выше** последнего обработанного
3. Если новых сообщений нет, завершает работу без обработки
4. При обнаружении новых сообщений:
   - Проверяет валидность (наличие текста, названия и автора)
   - Проверяет уникальность (отсутствие дубликатов в базе данных)
   - Загружает метаданные в БД
   - Обрабатывает обложки из медиа-файлов
   - Запускает алгоритм привязки файлов к книгам
   - Обновляет статус обработки сообщений

### Логика работы в полной синхронизации:
1. **При добавлении новой книги** - поиск файла для нее осуществляется по всему списку файлов из приватного канала
2. **При обнаружении нового файла** - поиск по всем книгам в БД без файлов

### Алгоритм работы в режиме обновления:
1. Определение ID последнего обработанного сообщения
2. Загрузка только сообщений с ID выше этого значения
3. Валидация и проверка уникальности сообщений
4. Обработка метаданных и обложек для новых книг
5. Поиск и привязка файлов к книгам
6. Обновление статуса обработки

### Запуск:
```bash
# Режим обновления
npx tsx src/scripts/run-book-worm.ts --mode update

# Полная синхронизация
npx tsx src/scripts/run-book-worm.ts --mode full
```

### Особенности:
- В режиме обновления обрабатываются только новые данные
- Алгоритм поиска соответствий предотвращает ложные совпадения
- Поддерживает обработку файлов различных форматов (.fb2, .zip)
- Ведет подробный лог всех операций