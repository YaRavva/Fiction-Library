# Использование Telegram интеграции

## Основные сервисы

### 1. TelegramMetadataService
Сервис для синхронизации метаданных книг из публичного канала.

**Основные методы:**
- `syncBooks(limit: number)` - синхронизация указанного количества книг
- `getMessages(channelId: string, limit: number, offsetId?: number)` - получение сообщений из канала

**Использование:**
```typescript
const metadataService = await TelegramMetadataService.getInstance();
const result = await metadataService.syncBooks(20);
```

### 2. TelegramFileService
Сервис для обработки файлов из приватного архива.

**Основные методы:**
- `getFilesToProcess(limit: number)` - получение списка файлов для обработки
- `processSingleFileById(messageId: number)` - обработка файла по ID сообщения
- `downloadAndProcessSingleFile(message: any)` - скачивание и обработка одного файла

**Использование:**
```typescript
const fileService = await TelegramFileService.getInstance();
const files = await fileService.getFilesToProcess(100);
const result = await fileService.processSingleFileById(12345);
```

### 3. BookWormService ("Книжный Червь")
Основной сервис синхронизации, объединяющий функции обоих сервисов.

**Основные методы:**
- `runFullSync()` - запуск полной синхронизации
- `syncNewMetadata()` - синхронизация новых метаданных
- `syncFiles()` - синхронизация файлов

**Использование:**
```typescript
const bookWorm = new BookWormService();
const result = await bookWorm.runFullSync();
```

## Скрипты командной строки

### run-book-worm.ts
Запуск полного цикла синхронизации "Книжного Червя".

```bash
npx tsx src/scripts/run-book-worm.ts
```

### scheduled-book-worm.ts
Запуск запланированной синхронизации "Книжного Червя".

```bash
npx tsx src/scripts/scheduled-book-worm.ts
```

### test-file-sync.ts
Тестирование синхронизации файлов (для отладки).

```bash
npx tsx src/scripts/test-file-sync.ts
```

### test-book-worm-logic.ts
Тестирование логики сопоставления файлов.

```bash
npx tsx src/scripts/test-book-worm-logic.ts
```

### find-missing-files.ts
Поиск книг без файлов.

```bash
npx tsx src/scripts/find-missing-files.ts
```

### analyze-book-duplicates.ts
Анализ дубликатов книг.

```bash
npx tsx src/scripts/analyze-book-duplicates.ts
```

### check-message-processing-order.ts
Проверка порядка обработки сообщений.

```bash
npx tsx src/scripts/check-message-processing-order.ts
```

## Логика работы сервисов

### Порядок синхронизации метаданных
1. При первом запуске проходит по всему каналу от новых сообщений к старым
2. При последующих запусках проверяет только новые сообщения
3. Найденные книги добавляются в базу данных

### Порядок синхронизации файлов
1. Получает список всех книг без файлов из базы данных
2. Получает список всех файлов из приватного архива (без ограничений)
3. Для каждой книги без файла производит поиск соответствующего файла
4. При нахождении подходящего файла:
   - Скачивает файл
   - Загружает в Supabase Storage
   - Привязывает к книге в базе данных

## Алгоритм поиска соответствий

### Получение файлов
- Получает ВСЕ файлы из приватного канала при каждом запуске
- Не ограничивается последними обработанными файлами

### Сопоставление книг и файлов
1. Для каждой книги без файла сервис получает все файлы из архива
2. Анализирует имя файла для извлечения метаданных (автор, название)
3. Ранжирует все файлы по степени релевантности:
   - Точные совпадения названия: +50 баллов
   - Точные совпадения автора: +30 баллов
   - Частичные совпадения названия: +20 баллов
   - Частичные совпадения автора: +20 баллов
   - Наличие и названия, и автора в имени файла: +30 баллов
   - Совпадение 50%+ слов из названия: +15 баллов
   - Совпадение по поисковым терминам: +5 баллов за термин
   - Штраф за ложные совпадения: -20 баллов
4. Выбирает файл с наивысшим рейтингом (минимум 30 баллов)
5. Если подходящий файл не найден, переходит к следующей книге

## Обработка ошибок

### Таймауты
- Все сетевые операции имеют таймауты (60 секунд для получения сообщений, 180 секунд для скачивания файлов)
- При превышении таймаута операция прерывается с ошибкой

### Повторные попытки
- При ошибках сетевых операций система пытается повторить операцию
- После 3 неудачных попыток операция помечается как ошибка

### Логирование
- Все операции логируются с подробной информацией
- Ошибки выводятся в консоль с трассировкой стека
- Успешные операции помечаются соответствующими метками

## Планирование задач

Сервисы могут быть запущены по расписанию для автоматической синхронизации:
- Ежедневная синхронизация метаданных
- Еженедельная синхронизация файлов
- Ежемесячная полная синхронизация

## Мониторинг

### Статистика выполнения
- Количество обработанных сообщений
- Количество добавленных/обновленных книг
- Количество привязанных файлов
- Количество ошибок

### Логирование
- Все операции записываются в лог с временными метками
- Ошибки сохраняются отдельно для последующего анализа
- Успешные операции помечаются зелеными метками