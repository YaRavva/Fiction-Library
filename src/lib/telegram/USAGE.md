# Использование Telegram интеграции

## Загрузка файлов книг

### Через админ панель

1. Перейдите в админ панель: `/admin`
2. Найдите раздел "Синхронизация"
3. Установите желаемый лимит в поле "Лимит публикаций" (по умолчанию 100)
4. Нажмите кнопку "Загрузить файлы"
5. Задачи будут добавлены в очередь для фоновой обработки
6. Отслеживайте процесс в разделе "Очередь загрузки"

### Через командную строку

```bash
# Загрузка файлов с лимитом (по умолчанию 5)
npm run test:download-limit

# Загрузка файлов с указанным лимитом
npm run test:download-limit 10
```

## Система очередей и воркеров

### Запуск воркера

```bash
# Запуск воркера загрузки файлов
npm run start-download-worker
```

### Проверка очереди

```bash
# Проверка статуса очереди загрузки
npm run check-download-queue
```

### Добавление задач в очередь

```bash
# Добавление задачи в очередь
npm run add-to-download-queue <messageId> <channelId> [priority]
```

### Тестирование системы очередей

```bash
# Показать справку
npm run test:queue-system

# Добавить тестовые задачи
npm run test:queue-system add-tasks 10

# Запустить воркер
npm run test:queue-system start-worker

# Проверить статус очереди
npm run test:queue-system check-queue

# Очистить очередь
npm run test:queue-system clear-queue
```

## Процесс загрузки файлов

1. **Добавление задач в очередь** - система получает файлы из приватного канала Telegram и добавляет задачи в очередь
2. **Фоновая обработка** - воркер постепенно обрабатывает задачи из очереди
3. **Поиск соответствий** - для каждого файла ищется соответствующая книга в базе данных
4. **Проверка дубликатов** - проверяется, не была ли книга уже обработана
5. **Загрузка файла** - файл загружается в Supabase Storage
6. **Привязка к книге** - файл привязывается к записи книги в базе данных

## Алгоритм поиска соответствий

1. Имя файла разбивается на слова
2. По каждому слову осуществляется поиск в полях "название" и "автор" книг
3. Найденные совпадения ранжируются по релевантности
4. Выбирается наиболее подходящая книга

## Возможные статусы обработки файлов

- ✅ **Успешно** - файл загружен и привязан к книге
- ⚠️ **Пропущен** - файл не был загружен по одной из причин:
  - Книга не найдена в базе данных
  - Файл уже был загружен ранее
  - Книга не импортирована из публичного канала
  - У книги уже есть файл
- ❌ **Ошибка** - произошла ошибка при обработке файла

## Рекомендации по использованию

1. **Начните с небольшого лимита** - рекомендуется начинать с лимита 10-20 файлов для проверки работы системы
2. **Используйте воркер для больших объемов** - для загрузки 900+ файлов используйте систему очередей и воркеров
3. **Мониторьте очередь** - регулярно проверяйте статус очереди для отслеживания прогресса
4. **Запускайте воркер отдельно** - воркер должен работать постоянно для обработки задач из очереди