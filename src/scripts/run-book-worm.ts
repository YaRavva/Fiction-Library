import { config } from 'dotenv';
import { resolve } from 'path';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
config({ path: resolve(__dirname, '../../.env') });

import { BookWormService } from '../lib/telegram/book-worm-service';

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ (–≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å API)
function sendStatus(status: string, progress: number = 0) {
    // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º, –≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ API
    console.log(`üìä –°—Ç–∞—Ç—É—Å: ${status}, –ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress}%`);
}

async function runBookWorm() {
    console.log('üêã –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ö–Ω–∏–∂–Ω–æ–≥–æ –ß–µ—Ä–≤—è...');
    
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    const TIMEOUT_MS = 15 * 60 * 1000; // 15 –º–∏–Ω—É—Ç
    
    // –°–æ–∑–¥–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    const timeout = setTimeout(() => {
        console.log('‚è∞ –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ...');
        process.exit(0);
    }, TIMEOUT_MS);
    
    try {
        // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
        const bookWorm = new BookWormService();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∫–∞–∑–∞–Ω –ª–∏ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
        const mode = process.argv[2] || 'auto'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º
        
        console.log(`üéØ –†–µ–∂–∏–º: ${mode === 'full' ? '–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è' : mode === 'update' ? '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ' : mode === 'index' ? '–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è' : '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π'}`);
        sendStatus(`–ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ ${mode}`, 0);
        
        let result;
        switch (mode) {
            case 'full':
                console.log('üêã –ó–∞–ø—É—Å–∫ –ö–Ω–∏–∂–Ω–æ–≥–æ –ß–µ—Ä–≤—è –≤ —Ä–µ–∂–∏–º–µ –ü–û–õ–ù–û–ô –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò...');
                sendStatus('–ù–∞—á–∞–ª–æ –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 5);
                result = await bookWorm.runFullSync();
                sendStatus('–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 100);
                break;
            case 'update':
                console.log('üêã –ó–∞–ø—É—Å–∫ –ö–Ω–∏–∂–Ω–æ–≥–æ –ß–µ—Ä–≤—è –≤ —Ä–µ–∂–∏–º–µ –û–ë–ù–û–í–õ–ï–ù–ò–Ø...');
                sendStatus('–ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 5);
                result = await bookWorm.runUpdateSync();
                sendStatus('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', 100);
                break;
            case 'index':
                console.log('üêã –ó–∞–ø—É—Å–∫ –ö–Ω–∏–∂–Ω–æ–≥–æ –ß–µ—Ä–≤—è –≤ —Ä–µ–∂–∏–º–µ –†–ê–°–®–ò–†–ï–ù–ù–û–ô –ò–ù–î–ï–ö–°–ê–¶–ò–ò...');
                sendStatus('–ù–∞—á–∞–ª–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏', 5);
                await bookWorm.advancedIndexMessages(100);
                sendStatus('–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 100);
                break;
            case 'auto':
            default:
                console.log('üêã –ó–∞–ø—É—Å–∫ –ö–Ω–∏–∂–Ω–æ–≥–æ –ß–µ—Ä–≤—è –≤ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ú —Ä–µ–∂–∏–º–µ...');
                sendStatus('–ù–∞—á–∞–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 5);
                result = await bookWorm.runAutoSync();
                sendStatus('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 100);
                break;
        }
        
        console.log('\nüéâ –ö–Ω–∏–∂–Ω—ã–π –ß–µ—Ä–≤—å –∑–∞–≤–µ—Ä—à–∏–ª —Å–≤–æ—é –º–∏—Å—Å–∏—é!');
        clearTimeout(timeout); // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
        process.exit(0);
    } catch (error) {
        console.error('üí• –ö–Ω–∏–∂–Ω—ã–π –ß–µ—Ä–≤—å —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–æ–π –æ—à–∏–±–∫–æ–π:', error);
        sendStatus('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è', 0);
        clearTimeout(timeout); // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
        process.exit(1);
    }
}

// –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞
runBookWorm().catch(console.error);