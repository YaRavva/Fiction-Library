# Скрипты для работы с файлами Telegram

## download-single-file.ts

Скрипт для загрузки и обработки единичного файла из Telegram по ID сообщения.

### Назначение

Этот скрипт позволяет загрузить и обработать один конкретный файл из приватного канала Telegram "Архив для фантастики" по указанному ID сообщения. Скрипт выполняет следующие действия:

1. Получает файл из Telegram по ID сообщения
2. Извлекает метаданные из имени файла
3. Ищет соответствующую книгу в базе данных
4. Проверяет, не был ли файл уже загружен
5. Загружает файл в Supabase Storage
6. Обновляет запись книги в базе данных
7. Обновляет запись в таблице telegram_processed_messages

### Использование

```bash
npx tsx src/scripts/download-single-file.ts <messageId>
```

Пример:
```bash
npx tsx src/scripts/download-single-file.ts 4379
```

### Особенности

- Автоматическая загрузка переменных окружения из файла .env
- Полное логирование процесса выполнения
- Проверка существующих записей в базе данных для предотвращения дубликатов
- Корректная обработка ошибок и исключений
- Проверка результатов в базе данных после выполнения
- Поддержка файлов в форматах .fb2 и .zip
- Точное получение сообщения по указанному ID (исправлено)
- Правильное формирование имени файла при скачивании с учетом реального формата

### Возможные статусы выполнения

1. **Успешно** - файл загружен и привязан к книге
2. **Пропущен** - файл не был загружен по одной из причин:
   - `book_not_found` - книга не найдена в базе данных
   - `book_not_imported` - книга не импортирована из публичного канала
   - `already_processed` - файл уже был загружен ранее
   - `book_already_has_file` - для книги уже есть загруженный файл (в таблице telegram_processed_messages)
   - `book_already_has_file_in_books_table` - в таблице books уже есть запись с файлом

3. **Ошибка** - произошла ошибка при обработке файла

## find-unprocessed-files.ts

Скрипт для поиска файлов, которые еще не были загружены из Telegram и могут быть обработаны.

### Использование

```bash
npx tsx src/scripts/find-unprocessed-files.ts
```

## find-file-by-book.ts

Скрипт для поиска файла по названию книги в базе данных и получения ID сообщения для загрузки.

### Использование

```bash
npx tsx src/scripts/find-file-by-book.ts "название или автор книги"
```

Пример:
```bash
npx tsx src/scripts/find-file-by-book.ts "Тайниковский"
```

## list-recent-files.ts

Скрипт для получения списка последних обработанных файлов из таблицы telegram_processed_messages.

### Использование

```bash
npx tsx src/scripts/list-recent-files.ts [limit]
```

Пример:
```bash
npx tsx src/scripts/list-recent-files.ts 20
```

## check-file-info.ts

Скрипт для проверки информации о конкретном файле по ID сообщения.

### Использование

```bash
npx tsx src/scripts/check-file-info.ts <messageId>
```

Пример:
```bash
npx tsx src/scripts/check-file-info.ts 4434
```

## Требования

Для работы скриптов необходим файл .env в корне проекта со следующими переменными:

```env
TELEGRAM_API_ID=...
TELEGRAM_API_HASH=...
TELEGRAM_SESSION=...
NEXT_PUBLIC_SUPABASE_URL=...
SUPABASE_SERVICE_ROLE_KEY=...
```