#!/usr/bin/env node
/**
 * Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸Ð½Ð´ÐµÐºÑÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Telegram
 * 
 * ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 100 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¸Ð· Telegram, Ð²Ñ‹ÑÑÐ½ÑÐµÑ‚, Ð½Ðµ Ð¿Ð¾ÑÐ²Ð¸Ð»Ð¾ÑÑŒ Ð»Ð¸ Ð½Ð¾Ð²Ñ‹Ñ… Ð¿Ð¾ÑÑ‚Ð¾Ð²
 * Ð¸ ÐµÑÐ»Ð¸ Ð´Ð°, Ñ‚Ð¾ Ð´Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ðµ Ð² telegram_messages_index.
 */

import dotenv from 'dotenv';
import { BookWormService } from '../lib/telegram/book-worm-service';

// Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
dotenv.config();

// Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² API
export async function runQuickIndexUpdate() {
  console.log('ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð½Ð´ÐµÐºÑÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Telegram...\n');
  
  try {
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ ÑÐµÑ€Ð²Ð¸ÑÐ°
    const bookWorm = new BookWormService();
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
    console.log('ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹...');
    const hasNewMessages = await bookWorm.checkForNewMessages();
    
    if (hasNewMessages.hasNewMessages) {
      console.log('ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð½Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ. Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸ÑŽ...');
      // Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸ÑŽ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
      const indexResult = await bookWorm.advancedIndexMessages(100);
      console.log(`\nâœ… Ð˜Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°:`);
      console.log(`   ÐŸÑ€Ð¾Ð¸Ð½Ð´ÐµÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹: ${indexResult.indexed}`);
      console.log(`   ÐžÑˆÐ¸Ð±Ð¾Ðº: ${indexResult.errors}`);
      
      return {
        success: true,
        indexedCount: indexResult.indexed,
        errorCount: indexResult.errors,
        newMessagesFound: true
      };
    } else {
      console.log('ÐÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾.');
      return {
        success: true,
        indexedCount: 0,
        errorCount: 0,
        newMessagesFound: false
      };
    }
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð¸Ð½Ð´ÐµÐºÑÐ°:', error);
    throw error;
  }
}

// Ð•ÑÐ»Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ, Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
if (require.main === module) {
  runQuickIndexUpdate()
    .then(() => process.exit(0))
    .catch(() => process.exit(1));
}