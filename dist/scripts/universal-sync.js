"use strict";
/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram
 *
 * –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
 * 1. –ë–µ—Ä–µ—Ç –æ–¥–Ω—É –ø—É–±–ª–∏–∫–∞—Ü–∏—é –∏–∑ –∫–∞–Ω–∞–ª–∞ Telegram
 * 2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —ç—Ç–æ–π –∫–Ω–∏–≥–∏ –≤ –ë–î
 * 3. –í —Å–ª—É—á–∞–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∫–Ω–∏–≥–∏ –≤ –ë–î –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞ –ø–æ–ª–Ω–æ—Ç—É –≤—Å–µ—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏ –¥–æ–ø–æ–ª–Ω—è–µ—Ç –∏—Ö –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
 * 4. –í—ã–ø–æ–ª–Ω—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∫–Ω–∏–≥)
 * 5. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ —Å –∞—Ä—Ö–∏–≤–æ–º –∫–Ω–∏–≥–∏ –∏ –≤ —Å–ª—É—á–∞–µ –µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –Ω–∞—Ö–æ–¥–∏—Ç —Ñ–∞–π–ª –≤ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º –∫–∞–Ω–∞–ª–µ,
 *    –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ –±–∞–∫–µ—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª –≤ –ë–î
 * 6. –í—ã–≤–æ–¥–∏—Ç –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –≤ –æ–∫–Ω–æ "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏"
 * 7. –ó–∞–Ω–æ—Å–∏—Ç –≤ –ë–î –¥–∞–Ω–Ω—ã–µ –æ–± –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π –∫–Ω–∏–≥–µ, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–π
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g = Object.create((typeof Iterator === "function" ? Iterator : Object).prototype);
    return g.next = verb(0), g["throw"] = verb(1), g["return"] = verb(2), typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.syncSinglePublication = syncSinglePublication;
var dotenv_1 = require("dotenv");
var supabase_js_1 = require("@supabase/supabase-js");
var sync_1 = require("../lib/telegram/sync");
// Load environment variables
(0, dotenv_1.config)({ path: '.env.local' });
(0, dotenv_1.config)({ path: '.env' });
// Supabase credentials
var supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
var serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
if (!supabaseUrl || !serviceRoleKey) {
    console.error('Missing Supabase environment variables');
    process.exit(1);
}
var supabaseAdmin = (0, supabase_js_1.createClient)(supabaseUrl, serviceRoleKey);
/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–Ω–∏–≥–∏ –≤ –ë–î –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º
 */
function findBookInDatabase(metadata) {
    return __awaiter(this, void 0, void 0, function () {
        var _a, data, error, fuzzyMatches, error_1;
        return __generator(this, function (_b) {
            switch (_b.label) {
                case 0:
                    _b.trys.push([0, 3, , 4]);
                    return [4 /*yield*/, supabaseAdmin
                            .from('books')
                            .select('*')
                            .eq('title', metadata.title)
                            .eq('author', metadata.author)
                            .single()];
                case 1:
                    _a = _b.sent(), data = _a.data, error = _a.error;
                    if (error && error.code !== 'PGRST116') { // PGRST116 - "single row expected"
                        console.error('Error searching for book:', error);
                        return [2 /*return*/, { exists: false }];
                    }
                    if (data) {
                        return [2 /*return*/, { exists: true, book: data }];
                    }
                    return [4 /*yield*/, supabaseAdmin.rpc('search_books', {
                            search_term: "".concat(metadata.title, " ").concat(metadata.author)
                        }).limit(1)];
                case 2:
                    fuzzyMatches = (_b.sent()).data;
                    if (fuzzyMatches && fuzzyMatches.length > 0) {
                        return [2 /*return*/, { exists: true, book: fuzzyMatches[0] }];
                    }
                    return [2 /*return*/, { exists: false }];
                case 3:
                    error_1 = _b.sent();
                    console.error('Error in findBookInDatabase:', error_1);
                    return [2 /*return*/, { exists: false }];
                case 4: return [2 /*return*/];
            }
        });
    });
}
/**
 * –î–æ–ø–æ–ª–Ω—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏
 */
function enrichBookMetadata(bookId, metadata) {
    return __awaiter(this, void 0, void 0, function () {
        var updateData, year, error, error_2;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    _a.trys.push([0, 3, , 4]);
                    updateData = {};
                    year = metadata.books && metadata.books.length > 0 ? metadata.books[0].year : undefined;
                    if (year && !isNaN(year)) {
                        updateData.publication_year = year;
                    }
                    if (metadata.description) {
                        updateData.description = metadata.description;
                    }
                    if (metadata.coverUrls && metadata.coverUrls.length > 0) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –æ–±–ª–æ–∂–∫—É –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω—É—é
                        updateData.cover_url = metadata.coverUrls[0];
                        // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ø–æ–ª–µ cover_urls –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Å—Ö–µ–º–µ –ë–î
                        // updateData.cover_urls = metadata.coverUrls;
                    }
                    if (!(Object.keys(updateData).length > 0)) return [3 /*break*/, 2];
                    return [4 /*yield*/, supabaseAdmin
                            .from('books')
                            .update(updateData)
                            .eq('id', bookId)];
                case 1:
                    error = (_a.sent()).error;
                    if (error) {
                        console.error('Error enriching book metadata:', error);
                    }
                    else {
                        console.log("\u2705 \u041C\u0435\u0442\u0430\u0434\u0430\u043D\u043D\u044B\u0435 \u043A\u043D\u0438\u0433\u0438 ".concat(bookId, " \u043E\u0431\u043E\u0433\u0430\u0449\u0435\u043D\u044B"));
                    }
                    _a.label = 2;
                case 2: return [3 /*break*/, 4];
                case 3:
                    error_2 = _a.sent();
                    console.error('Error in enrichBookMetadata:', error_2);
                    return [3 /*break*/, 4];
                case 4: return [2 /*return*/];
            }
        });
    });
}
/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ —É–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –∫–Ω–∏–≥
 */
function performDeduplication(bookId, metadata) {
    return __awaiter(this, void 0, void 0, function () {
        var _a, duplicates, error, bookToKeep, booksToDelete, _i, booksToDelete_1, duplicate, updateError, duplicateIds, deleteError, error_3;
        return __generator(this, function (_b) {
            switch (_b.label) {
                case 0:
                    _b.trys.push([0, 7, , 8]);
                    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤...');
                    return [4 /*yield*/, supabaseAdmin
                            .from('books')
                            .select('id, title, author, file_url, created_at')
                            .eq('title', metadata.title)
                            .eq('author', metadata.author)];
                case 1:
                    _a = _b.sent(), duplicates = _a.data, error = _a.error;
                    if (error) {
                        console.error('Error finding duplicates:', error);
                        return [2 /*return*/, false];
                    }
                    if (!duplicates || duplicates.length <= 1) {
                        console.log('‚úÖ –î—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                        return [2 /*return*/, true];
                    }
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                    duplicates.sort(function (a, b) { return new Date(b.created_at).getTime() - new Date(a.created_at).getTime(); });
                    bookToKeep = duplicates[0];
                    booksToDelete = duplicates.slice(1);
                    console.log("\u26A0\uFE0F  \u041D\u0430\u0439\u0434\u0435\u043D\u043E ".concat(duplicates.length, " \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u043E\u0432. \u041E\u0441\u0442\u0430\u0432\u043B\u044F\u0435\u043C: ").concat(bookToKeep.id));
                    _i = 0, booksToDelete_1 = booksToDelete;
                    _b.label = 2;
                case 2:
                    if (!(_i < booksToDelete_1.length)) return [3 /*break*/, 5];
                    duplicate = booksToDelete_1[_i];
                    if (!(duplicate.file_url && !bookToKeep.file_url && duplicate.id === bookId)) return [3 /*break*/, 4];
                    console.log("\uD83D\uDD04 \u041F\u0435\u0440\u0435\u043D\u043E\u0441 \u0444\u0430\u0439\u043B\u0430 \u0438\u0437 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u0430 ".concat(duplicate.id, " \u0432 \u043E\u0441\u043D\u043E\u0432\u043D\u0443\u044E \u0437\u0430\u043F\u0438\u0441\u044C ").concat(bookToKeep.id));
                    return [4 /*yield*/, supabaseAdmin
                            .from('books')
                            .update({
                            file_url: duplicate.file_url,
                            // –≠—Ç–∏ –ø–æ–ª—è –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è –≤ select, –ø–æ—ç—Ç–æ–º—É –∏—Ö –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                            // file_size: duplicate.file_size,
                            // file_format: duplicate.file_format,
                            // telegram_file_id: duplicate.telegram_file_id,
                            // storage_path: duplicate.storage_path,
                            updated_at: new Date().toISOString()
                        })
                            .eq('id', bookToKeep.id)];
                case 3:
                    updateError = (_b.sent()).error;
                    if (updateError) {
                        console.error('Error transferring file to main book:', updateError);
                    }
                    _b.label = 4;
                case 4:
                    _i++;
                    return [3 /*break*/, 2];
                case 5:
                    duplicateIds = booksToDelete.map(function (b) { return b.id; });
                    return [4 /*yield*/, supabaseAdmin
                            .from('books')
                            .delete()
                            .in('id', duplicateIds)];
                case 6:
                    deleteError = (_b.sent()).error;
                    if (deleteError) {
                        console.error('Error deleting duplicates:', deleteError);
                        return [2 /*return*/, false];
                    }
                    console.log("\u2705 \u0423\u0434\u0430\u043B\u0435\u043D\u043E ".concat(duplicateIds.length, " \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u043E\u0432"));
                    return [2 /*return*/, true];
                case 7:
                    error_3 = _b.sent();
                    console.error('Error in performDeduplication:', error_3);
                    return [2 /*return*/, false];
                case 8: return [2 /*return*/];
            }
        });
    });
}
/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –∫–Ω–∏–≥–∏ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –µ–≥–æ
 */
function ensureBookFile(bookId, metadata) {
    return __awaiter(this, void 0, void 0, function () {
        var _a, book, bookError, syncService_1, downloadError_1, syncService, archiveResults, searchTitle, searchAuthor, foundFile, _i, archiveResults_1, result, filename, updateError, processError_1, error_4;
        return __generator(this, function (_b) {
            switch (_b.label) {
                case 0:
                    _b.trys.push([0, 16, , 17]);
                    return [4 /*yield*/, supabaseAdmin
                            .from('books')
                            .select('file_url, telegram_file_id, title, author')
                            .eq('id', bookId)
                            .single()];
                case 1:
                    _a = _b.sent(), book = _a.data, bookError = _a.error;
                    if (bookError) {
                        console.error('Error fetching book:', bookError);
                        return [2 /*return*/, false];
                    }
                    // –ï—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                    if (book.file_url) {
                        console.log('‚úÖ –§–∞–π–ª –∫–Ω–∏–≥–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                        return [2 /*return*/, true];
                    }
                    if (!book.telegram_file_id) return [3 /*break*/, 6];
                    console.log("\uD83D\uDCE5 \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u0430 \u0438\u0437 Telegram (ID: ".concat(book.telegram_file_id, ")..."));
                    _b.label = 2;
                case 2:
                    _b.trys.push([2, 5, , 6]);
                    return [4 /*yield*/, sync_1.TelegramSyncService.getInstance()];
                case 3:
                    syncService_1 = _b.sent();
                    return [4 /*yield*/, syncService_1.downloadBook(parseInt(book.telegram_file_id))];
                case 4:
                    _b.sent();
                    console.log('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–Ω–∏–≥–µ');
                    return [2 /*return*/, true];
                case 5:
                    downloadError_1 = _b.sent();
                    console.error('Error downloading book file:', downloadError_1);
                    return [3 /*break*/, 6];
                case 6:
                    // –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –∏ –Ω–µ –º–æ–∂–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ telegram_file_id,
                    // –∏—â–µ–º –≤ –∫–∞–Ω–∞–ª–µ –∞—Ä—Ö–∏–≤–∞
                    console.log('üîç –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–∞ –≤ –∫–∞–Ω–∞–ª–µ –∞—Ä—Ö–∏–≤–∞...');
                    return [4 /*yield*/, sync_1.TelegramSyncService.getInstance()];
                case 7:
                    syncService = _b.sent();
                    return [4 /*yield*/, syncService.downloadAndProcessFilesDirectly(30)];
                case 8:
                    archiveResults = _b.sent();
                    searchTitle = book.title.toLowerCase();
                    searchAuthor = book.author.toLowerCase();
                    console.log("\uD83D\uDD0E \u041F\u043E\u0438\u0441\u043A \u0444\u0430\u0439\u043B\u0430 \u0434\u043B\u044F: ".concat(book.author, " - ").concat(book.title));
                    foundFile = false;
                    _i = 0, archiveResults_1 = archiveResults;
                    _b.label = 9;
                case 9:
                    if (!(_i < archiveResults_1.length)) return [3 /*break*/, 15];
                    result = archiveResults_1[_i];
                    if (!(result.success && result.filename)) return [3 /*break*/, 14];
                    filename = result.filename.toLowerCase();
                    if (!(filename.includes(searchAuthor.replace(/\s+/g, '_')) &&
                        filename.includes(searchTitle.replace(/\s+/g, '_')))) return [3 /*break*/, 14];
                    console.log("\uD83C\uDFAF \u041D\u0430\u0439\u0434\u0435\u043D \u043F\u043E\u0434\u0445\u043E\u0434\u044F\u0449\u0438\u0439 \u0444\u0430\u0439\u043B: ".concat(result.filename));
                    _b.label = 10;
                case 10:
                    _b.trys.push([10, 13, , 14]);
                    if (!result.messageId) return [3 /*break*/, 12];
                    return [4 /*yield*/, supabaseAdmin
                            .from('telegram_download_queue')
                            .update({
                            status: 'completed',
                            completed_at: new Date().toISOString()
                        })
                            .eq('message_id', result.messageId)];
                case 11:
                    updateError = (_b.sent()).error;
                    if (updateError) {
                        console.warn('Error updating download queue:', updateError);
                    }
                    _b.label = 12;
                case 12:
                    console.log('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–Ω–∏–≥–µ');
                    foundFile = true;
                    return [3 /*break*/, 15];
                case 13:
                    processError_1 = _b.sent();
                    console.error('Error processing found file:', processError_1);
                    return [3 /*break*/, 14];
                case 14:
                    _i++;
                    return [3 /*break*/, 9];
                case 15:
                    if (!foundFile) {
                        console.log("\uD83D\uDCC1 \u041F\u043E\u0434\u0445\u043E\u0434\u044F\u0449\u0438\u0439 \u0444\u0430\u0439\u043B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D \u0432 \u0430\u0440\u0445\u0438\u0432\u0435 (".concat(archiveResults.length, " \u0444\u0430\u0439\u043B\u043E\u0432 \u043F\u0440\u043E\u0432\u0435\u0440\u0435\u043D\u043E)"));
                        return [2 /*return*/, false];
                    }
                    return [2 /*return*/, true];
                case 16:
                    error_4 = _b.sent();
                    console.error('Error in ensureBookFile:', error_4);
                    return [2 /*return*/, false];
                case 17: return [2 /*return*/];
            }
        });
    });
}
/**
 * –û—Ç–º–µ—á–∞–µ—Ç –∫–Ω–∏–≥—É –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é
 */
function markBookAsProcessed(bookId) {
    return __awaiter(this, void 0, void 0, function () {
        var error, error_5;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    _a.trys.push([0, 2, , 3]);
                    return [4 /*yield*/, supabaseAdmin
                            .from('books')
                            .update({
                            updated_at: new Date().toISOString(),
                            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
                            // processed_at: new Date().toISOString()
                        })
                            .eq('id', bookId)];
                case 1:
                    error = (_a.sent()).error;
                    if (error) {
                        console.error('Error marking book as processed:', error);
                    }
                    else {
                        console.log("\u2705 \u041A\u043D\u0438\u0433\u0430 ".concat(bookId, " \u043E\u0442\u043C\u0435\u0447\u0435\u043D\u0430 \u043A\u0430\u043A \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u0430\u043D\u043D\u0430\u044F"));
                    }
                    return [3 /*break*/, 3];
                case 2:
                    error_5 = _a.sent();
                    console.error('Error in markBookAsProcessed:', error_5);
                    return [3 /*break*/, 3];
                case 3: return [2 /*return*/];
            }
        });
    });
}
/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
 */
function syncSinglePublication() {
    return __awaiter(this, void 0, void 0, function () {
        var actions, bookId, syncService, metadataList, metadata, bookCheck, _a, data, error, dedupResult, fileResult, error_6, syncService, shutdownError_1;
        var _b;
        return __generator(this, function (_c) {
            switch (_c.label) {
                case 0:
                    actions = [];
                    _c.label = 1;
                case 1:
                    _c.trys.push([1, 16, 17, 22]);
                    console.log('üöÄ –ù–∞—á–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ–¥–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏–∑ Telegram...');
                    actions.push('–ù–∞—á–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
                    return [4 /*yield*/, sync_1.TelegramSyncService.getInstance()];
                case 2:
                    syncService = _c.sent();
                    return [4 /*yield*/, syncService.syncMetadata(1)];
                case 3:
                    metadataList = _c.sent();
                    if (!metadataList || metadataList.length === 0) {
                        return [2 /*return*/, {
                                success: false,
                                message: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ Telegram –∫–∞–Ω–∞–ª–µ',
                                actions: __spreadArray(__spreadArray([], actions, true), ['–ù–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏'], false)
                            }];
                    }
                    metadata = metadataList[0];
                    console.log("\uD83D\uDCDA \u041F\u043E\u043B\u0443\u0447\u0435\u043D\u044B \u043C\u0435\u0442\u0430\u0434\u0430\u043D\u043D\u044B\u0435: \"".concat(metadata.title, "\" \u0430\u0432\u0442\u043E\u0440\u0430 ").concat(metadata.author));
                    actions.push("\u041F\u043E\u043B\u0443\u0447\u0435\u043D\u044B \u043C\u0435\u0442\u0430\u0434\u0430\u043D\u043D\u044B\u0435 \u043A\u043D\u0438\u0433\u0438: \"".concat(metadata.title, "\""));
                    return [4 /*yield*/, findBookInDatabase(metadata)];
                case 4:
                    bookCheck = _c.sent();
                    if (!(bookCheck.exists && bookCheck.book)) return [3 /*break*/, 5];
                    bookId = bookCheck.book.id;
                    console.log("\u2705 \u041A\u043D\u0438\u0433\u0430 \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0411\u0414 (ID: ".concat(bookId, ")"));
                    actions.push("\u041A\u043D\u0438\u0433\u0430 \u043D\u0430\u0439\u0434\u0435\u043D\u0430 \u0432 \u0411\u0414 (ID: ".concat(bookId, ")"));
                    return [3 /*break*/, 7];
                case 5: return [4 /*yield*/, supabaseAdmin
                        .from('books')
                        .insert({
                        title: metadata.title,
                        author: metadata.author,
                        publication_year: metadata.books && metadata.books.length > 0 ? metadata.books[0].year : undefined,
                        description: metadata.description,
                        cover_url: ((_b = metadata.coverUrls) === null || _b === void 0 ? void 0 : _b[0]) || null,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                        .select()
                        .single()];
                case 6:
                    _a = _c.sent(), data = _a.data, error = _a.error;
                    if (error) {
                        throw new Error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F \u0437\u0430\u043F\u0438\u0441\u0438 \u043A\u043D\u0438\u0433\u0438: ".concat(error.message));
                    }
                    bookId = data.id;
                    console.log("\uD83C\uDD95 \u0421\u043E\u0437\u0434\u0430\u043D\u0430 \u043D\u043E\u0432\u0430\u044F \u0437\u0430\u043F\u0438\u0441\u044C \u043A\u043D\u0438\u0433\u0438 (ID: ".concat(bookId, ")"));
                    actions.push("\u0421\u043E\u0437\u0434\u0430\u043D\u0430 \u043D\u043E\u0432\u0430\u044F \u0437\u0430\u043F\u0438\u0441\u044C \u043A\u043D\u0438\u0433\u0438 (ID: ".concat(bookId, ")"));
                    _c.label = 7;
                case 7:
                    if (!bookId) return [3 /*break*/, 9];
                    return [4 /*yield*/, enrichBookMetadata(bookId, metadata)];
                case 8:
                    _c.sent();
                    actions.push('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –¥–æ–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏');
                    return [3 /*break*/, 10];
                case 9:
                    actions.push('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –∫–Ω–∏–≥–∏ –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö');
                    _c.label = 10;
                case 10:
                    if (!bookId) return [3 /*break*/, 14];
                    return [4 /*yield*/, performDeduplication(bookId, metadata)];
                case 11:
                    dedupResult = _c.sent();
                    if (dedupResult) {
                        actions.push('–í—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤');
                    }
                    else {
                        actions.push('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏');
                    }
                    return [4 /*yield*/, ensureBookFile(bookId, metadata)];
                case 12:
                    fileResult = _c.sent();
                    if (fileResult) {
                        actions.push('–§–∞–π–ª –∫–Ω–∏–≥–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏');
                    }
                    else {
                        actions.push('–§–∞–π–ª –∫–Ω–∏–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞');
                    }
                    // 6. –û—Ç–º–µ—á–∞–µ–º –∫–Ω–∏–≥—É –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é
                    return [4 /*yield*/, markBookAsProcessed(bookId)];
                case 13:
                    // 6. –û—Ç–º–µ—á–∞–µ–º –∫–Ω–∏–≥—É –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é
                    _c.sent();
                    actions.push('–ö–Ω–∏–≥–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è');
                    return [3 /*break*/, 15];
                case 14:
                    actions.push('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –∫–Ω–∏–≥–∏');
                    _c.label = 15;
                case 15:
                    console.log('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                    return [2 /*return*/, {
                            success: true,
                            message: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞',
                            bookId: bookId,
                            actions: actions
                        }];
                case 16:
                    error_6 = _c.sent();
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error_6);
                    actions.push("\u041E\u0448\u0438\u0431\u043A\u0430: ".concat(error_6 instanceof Error ? error_6.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    return [2 /*return*/, {
                            success: false,
                            message: error_6 instanceof Error ? error_6.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',
                            bookId: bookId,
                            actions: actions
                        }];
                case 17:
                    _c.trys.push([17, 20, , 21]);
                    return [4 /*yield*/, sync_1.TelegramSyncService.getInstance()];
                case 18:
                    syncService = _c.sent();
                    return [4 /*yield*/, syncService.shutdown()];
                case 19:
                    _c.sent();
                    return [3 /*break*/, 21];
                case 20:
                    shutdownError_1 = _c.sent();
                    console.error('Error during shutdown:', shutdownError_1);
                    return [3 /*break*/, 21];
                case 21: return [7 /*endfinally*/];
                case 22: return [2 /*return*/];
            }
        });
    });
}
// –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞–ø—Ä—è–º—É—é
if (require.main === module) {
    syncSinglePublication()
        .then(function (result) {
        console.log('\nüìã –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–°–õ–ï–î–ù–ï–ô –û–ü–ï–†–ê–¶–ò–ò:');
        console.log('================================');
        console.log("\u0421\u0442\u0430\u0442\u0443\u0441: ".concat(result.success ? '–£–°–ü–ï–®–ù–û' : '–û–®–ò–ë–ö–ê'));
        console.log("\u0421\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0435: ".concat(result.message));
        if (result.bookId) {
            console.log("ID \u043A\u043D\u0438\u0433\u0438: ".concat(result.bookId));
        }
        console.log('\n–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:');
        result.actions.forEach(function (action, index) {
            console.log("".concat(index + 1, ". ").concat(action));
        });
        console.log('================================');
        process.exit(result.success ? 0 : 1);
    })
        .catch(function (error) {
        console.error('.Fatal error:', error);
        process.exit(1);
    });
}
