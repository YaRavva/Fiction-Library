# Обновление системы дедупликации книг

## Состояние системы на 22 октября 2025 г.

### Обновленная логика дедупликации в сервисе книжного червя

Система дедупликации книг в сервисе книжного червя была обновлена для использования улучшенной логики, обеспечивая более точное определение дубликатов и лучшую интеграцию с основной системой дедупликации.

### Изменения в логике

#### 1. Использование улучшенных функций дедупликации

Обновленные сервисы теперь используют функции из `src/lib/book-deduplication-service.ts`:

```typescript
import { checkForBookDuplicates, normalizeBookText, selectBestBookFromDuplicates, mergeBookData } from '../lib/book-deduplication-service';
```

#### 2. Улучшенная проверка дубликатов

Вместо простого сравнения названия и автора, система теперь:

- Нормализует текст перед сравнением (удаляет годы в скобках, обозначения языков, приводит к нижнему регистру, удаляет эмодзи и другие элементы)
- Проверяет более точное совпадение с использованием нормализованных данных
- Учитывает частичные совпадения и возвращает все возможные дубликаты для дальнейшего анализа

#### 3. Улучшенная логика обработки дубликатов

При обнаружении дубликатов система:

- Использует `selectBestBookFromDuplicates()` для выбора лучшей книги из дубликатов
- Использует `mergeBookData()` для объединения данных из разных источников
- Обновляет существующую запись с лучшими данными из разных источников

### Обновленные файлы

#### `src/lib/telegram/metadata-service.ts`

- Обновлена функция `importMetadataWithDeduplication()` для использования улучшенной логики дедупликации
- Обновлена функция `syncBooks()` для использования улучшенной логики при проверке существования книг
- Добавлена нормализация текста при проверке совпадений
- Улучшена логика объединения данных из разных источников

#### `src/lib/telegram/book-worm-service.ts`

- Обновлена логика проверки существования книг перед добавлением новых в методе `runUpdateSync()`
- Интегрированы функции из `book-deduplication-service.ts` для более точного определения дубликатов
- Обновлена проверка дубликатов в методе синхронизации обновлений

### Интеграция с существующими скриптами

Скрипты `remove-book-duplicates.ts` и `check-book-duplicates.ts` продолжают использовать ту же логику нормализации текста, что и основная система дедупликации, обеспечивая согласованность подхода ко всему проекту.

### Проверка дедупликации

Для проверки работы обновленной логики дедупликации можно:

1. Запустить скрипт проверки дубликатов:
   ```bash
   npx tsx check-book-duplicates.ts
   ```

2. Запустить скрипт удаления дубликатов:
   ```bash
   npx tsx remove-book-duplicates.ts
   ```

3. Использовать API endpoint для синхронизации книг:
   ```
   POST /api/admin/book-worm
   Authorization: Bearer <admin_token>
   Content-Type: application/json
   
   {
     "mode": "update"
   }
   ```

### Логика нормализации текста

При проверке дубликатов система использует функцию `normalizeBookText()` для:

- Применения Unicode нормализации (NFKC) для устранения различий в представлении символов
- Приведения к нижнему регистру
- Удаления эмодзи
- Удаления лет в скобках (например, "(2023)")
- Удаления обозначений языков ("ru", "en" и др.)
- Удаления других символов в скобках (кроме лет)
- Удаления лишних пробелов

Это позволяет системе более точно определять дубликаты с незначительными различиями в написании.