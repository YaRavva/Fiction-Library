# Улучшенная система дедупликации книг

## Обзор

В проект добавлена улучшенная система дедупликации книг, которая предотвращает появление дубликатов в базе данных и позволяет удалять уже существующие дубликаты.

## Компоненты системы

### 1. Скрипты удаления дубликатов

- `remove-book-duplicates.ts` - скрипт для безопасного удаления дубликатов книг из БД
- `remove-book-duplicates-enhanced.ts` - улучшенная версия с учетом наличия файлов при выборе лучшей книги

### 2. Сервис дедупликации

- `src/lib/book-deduplication-service.ts` - улучшенный сервис с функциями:
  - `checkForBookDuplicates()` - проверка наличия дубликатов
  - `normalizeBookText()` - нормализация текста для сравнения
  - `selectBestBookFromDuplicates()` - выбор лучшей книги из дубликатов
  - `mergeBookData()` - объединение данных из разных источников

### 3. Улучшенная логика в существующих сервисах

- `src/lib/telegram/metadata-service.ts` - обновленная логика дедупликации при импорте метаданных

## Использование скриптов

### Удаление дубликатов

```bash
npx tsx remove-book-duplicates.ts
```

или

```bash
npx tsx remove-book-duplicates-enhanced.ts
```

Оба скрипта требуют подтверждения перед удалением.

### Интеграция в приложение

Используйте функции из `src/lib/book-deduplication-service.ts` в ваших сервисах для проверки дубликатов:

```typescript
import { checkForBookDuplicates, normalizeBookText } from '../lib/book-deduplication-service';

// Пример использования
const duplicates = await checkForBookDuplicates(title, author, publicationYear, normalizeBookText);
```

## Логика улучшенной дедупликации

При проверке дубликатов система учитывает:
- Наличие файла (file_url или telegram_file_id)
- Наличие обложки (cover_url)
- Наличие описания (description)
- Наличие жанров (genres)
- Наличие тегов (tags)
- Дату создания (предпочтение отдается более старым книгам)

При обнаружении дубликатов система:
- Выбирает лучшую книгу на основе вышеуказанных критериев
- Объединяет данные из разных источников
- Обновляет существующую запись, если новые данные лучше
- Пропускает дубликаты без создания новых записей

## Нормализация текста

Функция `normalizeBookText` удаляет:
- Годы в скобках (например, "(2023)")
- Обозначение языка "ru"
- Приводит к нижнему регистру
- Удаляет лишние пробелы

Это позволяет более точно сопоставлять названия и авторов книг с незначительными различиями в написании.