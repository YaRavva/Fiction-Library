# Новые функции синхронизации сообщений Telegram

## Обзор

В этой версии были реализованы улучшенные функции синхронизации сообщений Telegram, которые позволяют эффективно находить и обрабатывать новые сообщения без необходимости повторной обработки уже обработанных сообщений.

## Основные изменения

### 1. Изменение типа данных message_id

**Проблема**: Ранее message_id хранился как TEXT, что приводило к неправильной сортировке (лексикографической вместо числовой).

**Решение**: 
- Изменен тип столбца message_id в таблице `telegram_messages_index` с TEXT на BIGINT
- Это обеспечивает правильную числовую сортировку (4929 > 999)

### 2. Новые методы в TelegramMetadataService

#### getLastProcessedMessageId()
Получает ID последнего обработанного сообщения из таблицы `telegram_processed_messages`.

#### findNewMessages(limit)
Находит новые сообщения, которые еще не были обработаны:
- Сравнивает ID последнего обработанного сообщения с ID сообщений в индексе
- Возвращает список новых сообщений, отсортированных по возрастанию ID

#### getMessageById(chatId, messageId)
Получает конкретное сообщение по его ID из Telegram.

### 3. Улучшенная синхронизация

Метод `syncBooks()` был переработан для использования нового подхода:
- Находит новые сообщения с помощью `findNewMessages()`
- Получает полные сообщения из Telegram только для новых записей
- Обрабатывает только новые сообщения, избегая повторной обработки

## Преимущества

1. **Эффективность**: Не обрабатывает уже обработанные сообщения повторно
2. **Правильная сортировка**: Числовая сортировка ID сообщений
3. **Производительность**: Значительно уменьшено количество запросов к Telegram API
4. **Надежность**: Лучшая обработка ошибок и логирование

## Использование

```typescript
// Получить экземпляр сервиса
const metadataService = await TelegramMetadataService.getInstance();

// Найти новые сообщения
const newMessages = await metadataService.findNewMessages(10);

// Синхронизировать новые книги
const result = await metadataService.syncBooks(10);
```

## Структура таблиц

### telegram_messages_index
- `message_id`: BIGINT (основной идентификатор сообщения)
- `channel`: TEXT (идентификатор канала)
- `author`: TEXT (автор книги)
- `title`: TEXT (название книги)

### telegram_processed_messages
- `message_id`: TEXT (ID обработанного сообщения)
- `book_id`: UUID (связь с книгой в БД)
- `processed_at`: TIMESTAMPTZ (время обработки)

## Принцип работы

1. При индексации все сообщения сохраняются в `telegram_messages_index`
2. При обработке сообщений записи добавляются в `telegram_processed_messages`
3. При следующей синхронизации система:
   - Получает ID последнего обработанного сообщения
   - Находит все сообщения в индексе с ID больше последнего обработанного
   - Обрабатывает только эти новые сообщения

Этот подход обеспечивает инкрементальную синхронизацию без необходимости повторной обработки всего объема данных.