# Обновленная система синхронизации метаданных и файлов из Telegram

## Обзор

Эта документация описывает обновленную функциональность для синхронизации метаданных и файлов из Telegram каналов, загрузки их в Supabase Storage и установки связи с книгами в БД.

## Архитектура

### Компоненты системы

1. **TelegramMetadataService** - сервис для синхронизации метададанных из публичного канала
2. **TelegramFileService** - сервис для обработки файлов из приватного канала
3. **TelegramService** - базовый клиент для работы с Telegram API
4. **MetadataParser** - парсер текстовых сообщений для извлечения метаданных
5. **Очередь загрузок** - таблица `telegram_download_queue` в БД
6. **BackgroundDownloadHandler** - фоновый обработчик для загрузки файлов
7. **BackgroundSyncHandler** - фоновый обработчик для синхронизации метаданных
8. **TaskManager** - менеджер задач для отслеживания прогресса

### Поля и их назначение

#### В таблице `books`:
- **telegram_post_id** - ID сообщения из канала метаданных (публичный канал), содержащего информацию о книге
- **telegram_file_id** - ID сообщения из канала файлов (приватный канал), содержащего файл книги
- **storage_path** - путь к файлу в Supabase Storage

#### В таблице `telegram_processed_messages`:
- **message_id** - ID сообщения из канала метаданных (публичный канал)
- **telegram_file_id** - ID сообщения из канала файлов (приватный канал), содержащего файл книги для данной книги
- **book_id** - ID книги в таблице books

## Правильная последовательность действий

### Синхронизация метаданных

1. Получение сообщений из публичного канала с метаданными
2. Парсинг текста сообщения для извлечения метаданных (название, автор, описание, жанры, теги)
3. Проверка наличия книги в БД по названию и автору
4. Если книга не существует:
   - Извлечение обложек из медиа-файлов сообщения
   - Загрузка обложек в Supabase Storage (бакет covers)
   - Создание новой записи книги в БД
5. Если книга существует:
   - Обновление метаданных при необходимости
   - Создание серии при наличии состава книг
6. Запись информации о обработанном сообщении в `telegram_processed_messages`

### Синхронизация файлов

1. Получение сообщений из приватного канала с файлами
2. Извлечение имени файла из сообщения
3. Релевантный поиск книги в БД по имени файла
4. Если книга найдена с высокой степенью релевантности:
   - Проверка, что для книги еще не загружен файл
   - Скачивание файла из приватного канала
   - Загрузка файла в Supabase Storage (бакет books)
   - Обновление записи книги информацией о файле
   - Запись информации в `telegram_processed_messages`
5. Если книга не найдена или файл уже загружен:
   - Файл пропускается даже без скачивания

## Улучшенная логика обработки

### Обработка дубликатов

Система теперь использует двухуровневую проверку дубликатов:
1. На этапе обработки сообщений - книги, которые уже существуют в БД, пропускаются сразу
2. На этапе импорта - дополнительная проверка на случай, если книга была добавлена между проверкой и импортом

### Обработка пустых значений

Система теперь корректно обрабатывает сообщения с отсутствующими названиями или авторами:
- Такие сообщения пропускаются с соответствующей причиной
- Улучшена обработка пустых имен файлов

### Улучшенные отчеты

Отчеты теперь корректно отображают:
- Общее количество пропущенных книг (включая те, что пропущены на этапе обработки сообщений)
- Понятные причины пропуска файлов
- Более детализированную статистику

## Асинхронная обработка с отслеживанием прогресса

### Для метаданных:
Система поддерживает асинхронную синхронизацию метаданных с отслеживанием прогресса:
- Запуск фоновой задачи с уникальным ID
- Отслеживание прогресса через TaskManager
- Получение статуса и результатов по ID задачи

### Для файлов:
Система поддерживает асинхронную загрузку файлов с отслеживанием прогресса:
- Запуск фоновой задачи с уникальным ID
- Отслеживание прогресса через TaskManager
- Получение статуса и результатов по ID задачи

## Возможные статусы выполнения

### Для метаданных:
1. **Добавлена** - новая книга успешно добавлена в БД
2. **Обновлена** - существующая книга обновлена с новыми метаданными
3. **Пропущена** - книга пропущена по одной из причин:
   - `book already exists in database` - книга уже существует в базе данных
   - `missing title or author` - отсутствует название или автор
   - `no text content` - сообщение без текста
   - `metadata complete` - метаданные полные
   - `existing book has description` - у существующей книги лучшее описание
   - `existing book has genres` - у существующей книги есть жанры
   - `existing book has tags` - у существующей книги есть теги
   - `existing book has cover` - у существующей книги есть обложка
   - `existing book has telegram post id` - у существующей книги есть ID сообщения

### Для файлов:
1. **Успешно** - файл загружен и привязан к книге
2. **Пропущен** - файл не был загружен по одной из причин:
   - `book_not_found` - книга не найдена в базе данных
   - `book_not_imported` - книга не импортирована из публичного канала
   - `already_processed` - файл уже был загружен ранее
   - `book_already_has_file` - для книги уже есть загруженный файл (в таблице telegram_processed_messages)
   - `book_already_has_file_in_books_table` - в таблице books уже есть запись с файлом
3. **Ошибка** - произошла ошибка при обработке файла

## Использование

### Синхронизация метаданных

#### Через API (рекомендуется):
```bash
# Синхронная синхронизация
curl -X POST http://localhost:3000/api/admin/sync \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"limit": 10}'

# Асинхронная синхронизация
curl -X POST http://localhost:3000/api/admin/sync-async \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"limit": 10}'

# Получение статуса асинхронной синхронизации
curl -X GET http://localhost:3000/api/admin/sync-async?operationId=YOUR_OPERATION_ID \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### Через скрипт:
```bash
# Синхронная синхронизация
npx tsx src/scripts/sync-books.ts [limit]

# Асинхронная синхронизация
npx tsx src/scripts/sync-books-async.ts [limit]
```

### Синхронизация файлов

#### Через API (рекомендуется):
```bash
# Асинхронная загрузка файлов
curl -X POST http://localhost:3000/api/admin/download-files-async \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"limit": 50}'

# Получение статуса асинхронной загрузки
curl -X GET http://localhost:3000/api/admin/download-files-async?operationId=YOUR_OPERATION_ID \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### Через скрипт:
```bash
# Асинхронная загрузка файлов
npx tsx src/scripts/download-files-async.ts [limit]
```

### Обработка отдельного файла

#### Через скрипт:
```bash
npx tsx src/scripts/download-single-file.ts <messageId>
```

Пример:
```bash
npx tsx src/scripts/download-single-file.ts 4379
```

## Конфигурация

Убедитесь, что в .env файлах установлены следующие переменные:

```env
TELEGRAM_API_ID=your_api_id
TELEGRAM_API_HASH=your_api_hash
TELEGRAM_SESSION=your_session_string
TELEGRAM_METADATA_CHANNEL_ID=your_metadata_channel_id
TELEGRAM_FILES_CHANNEL_ID=your_files_channel_id
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

## Решение проблем

### Проблемы с доступом к каналам

1. Убедитесь, что вы являетесь участником обоих каналов (публичного и приватного)
2. Проверьте правильность TELEGRAM_METADATA_CHANNEL_ID и TELEGRAM_FILES_CHANNEL_ID
3. Запустите `npx tsx src/scripts/test-telegram-connection.ts` для проверки подключения

### Проблемы с синхронизацией метаданных

1. Проверьте, что публичный канал содержит текстовые сообщения с метаданными
2. Убедитесь, что формат сообщений соответствует ожидаемому
3. Проверьте логи для выявления проблем с парсингом

### Проблемы с загрузкой файлов

1. Проверьте логи фонового обработчика
2. Убедитесь, что у service role есть доступ к Supabase Storage
3. Проверьте, что бакеты books и covers существуют и доступны

## Безопасность

- Все API endpoints защищены проверкой прав администратора
- Скрипты используют service role для доступа к Supabase
- Не храните чувствительные данные в логах
- Регулярно обновляйте сессионные данные Telegram

## Мониторинг

### Через админку:
- Страница админки содержит компоненты для мониторинга синхронизации
- Отображается статус последней операции
- Доступна история синхронизаций

### Через логи:
- Все операции логируются с подробной информацией
- Логи содержат информацию о пропущенных файлах и причинах пропуска
- Ошибки сопровождаются детальной информацией для диагностики