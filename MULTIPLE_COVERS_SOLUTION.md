# Решение проблемы с множественными обложками для серий

## Проблема
При импорте книг из Telegram, не все обложки из альбомов корректно загружались и отображались в карточке серии, несмотря на то что:
- Один пост в Telegram = одна карточка книги/серии
- Все обложки из альбома должны отображаться в этой одной карточке

## Выявленные проблемы

1. **Некорректная обработка сообщений без текста в альбомах** - некоторые сообщения в альбоме содержат только медиа без текста
2. **Неполное обновление существующих серий** - при повторной синхронизации обложки не обновлялись
3. **Недостаточное логирование** - сложно было отладить процесс загрузки обложек

## Внесенные исправления

### 1. Улучшена обработка альбомов в sync.ts
- Добавлена предварительная фаза сбора всех сообщений группы
- Улучшена логика обработки сообщений без текста в альбомах
- Добавлено более подробное логирование процесса загрузки обложек

### 2. Исправлено обновление серий в sync/route.ts
- Добавлено обновление обложек для существующих серий
- Обложки теперь правильно обновляются при повторной синхронизации

### 3. Добавлены отладочные скрипты
- `src/scripts/debug-cover-loading.ts` - для диагностики процесса загрузки обложек

## Как работает исправленная система

1. **Сбор сообщений**: Все сообщения собираются в два прохода
   - Первый проход: собираем все сообщения с `groupedId`
   - Второй проход: обрабатываем сообщения с текстом

2. **Обработка альбомов**: 
   - Когда встречается сообщение с текстом и `groupedId`, обрабатываем все сообщения из этой группы
   - Загружаем все изображения из группы, независимо от того, содержат ли они текст

3. **Сохранение обложек**:
   - Все обложки сохраняются в массив `coverUrls`
   - При создании серии: сохраняем все обложки в поле `cover_urls`
   - При обновлении серии: обновляем обложки если они изменились

## Проверка исправлений

Для проверки можно запустить отладочный скрипт:
```bash
npx tsx src/scripts/debug-cover-loading.ts
```

Или выполнить синхронизацию с включенным логированием, чтобы увидеть детальный процесс загрузки обложек.

## Результат

Теперь все обложки из Telegram альбомов корректно загружаются и отображаются в карточке серии, что соответствует требованию "один пост = одна карточка, но все обложки отображаются".