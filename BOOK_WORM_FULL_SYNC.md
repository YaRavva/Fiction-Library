# Полная синхронизация "Книжного Червя"

## Обзор

"Книжный Червь" теперь поддерживает полную синхронизацию, которая позволяет проверить наличие пропущенных сообщений в канале с метаданными и выполнить синхронизацию всех данных при необходимости.

## Как это работает

### 1. Проверка необходимости полной синхронизации

При запуске "Книжный Червь" выполняет следующие проверки:

1. **Проверка количества обработанных сообщений**:
   - Если в таблице `telegram_processed_messages` нет записей, требуется полная синхронизация

2. **Проверка наличия пропущенных сообщений**:
   - Получает все сообщения из канала с метаданными
   - Сравнивает их с записями в таблице `telegram_processed_messages`
   - Если найдены непrocessed сообщения, требуется полная синхронизация

### 2. Выполнение полной синхронизации

Если требуется полная синхронизация, "Книжный Червь" выполняет следующие шаги:

1. **Получение всех сообщений из канала**:
   - Загружает все сообщения из канала с метаданными по 100 за раз
   - Обрабатывает сообщения от новых к старым

2. **Обработка метаданных**:
   - Парсит текст каждого сообщения для извлечения метаданных книг
   - Проверяет наличие книги в базе данных
   - Извлекает обложки из медиа-файлов сообщений
   - Импортирует метаданные с дедупликацией

3. **Сопоставление файлов**:
   - Получает список книг без файлов из базы данных
   - Получает все файлы из приватного архива
   - Выполняет интеллектуальный поиск соответствий между книгами и файлами
   - Привязывает найденные файлы к книгам

### 3. Нормальная синхронизация

Если полная синхронизация не требуется, "Книжный Червь" выполняет нормальную синхронизацию:

1. **Синхронизация новых метаданных**:
   - Получает новые сообщения из канала с метаданными (начиная с последнего обработанного)
   - Обрабатывает метаданные и импортирует в базу данных

2. **Сопоставление файлов**:
   - Получает список книг без файлов из базы данных
   - Получает файлы из приватного архива
   - Выполняет сопоставление и привязку файлов

## Расширенная индексация метаданных

### 4. Индексация сообщений

Новый метод индексации позволяет более эффективно отслеживать новые сообщения в Telegram:

1. **Индексация базовой информации**:
   - Индексирует только ID сообщения, автора и название книги
   - Используется для отслеживания новых сообщений
   - Не дублирует полные метаданные из таблицы `books`

2. **Поиск по ключевым словам**:
   - Позволяет искать сообщения по автору и названию
   - Ранжирует результаты по релевантности
   - Поддерживает частичное совпадение по ключевым словам

3. **Статистика индекса**:
   - Отслеживает общее количество индексированных сообщений
   - Мониторит количество сообщений с автором и названием

## Преимущества

1. **Проверка целостности данных**:
   - Автоматически выявляет пропущенные сообщения
   - Обеспечивает полноту данных в базе

2. **Эффективность**:
   - Нормальная синхронизация выполняется только для новых данных
   - Полная синхронизация выполняется только при необходимости

3. **Надежность**:
   - Предотвращает потерю данных из-за сбоев в обработке
   - Обеспечивает согласованность данных между Telegram и базой

4. **Улучшенный поиск**:
   - Расширенная индексация позволяет быстрее находить нужные сообщения
   - Поиск по ключевым словам упрощает навигацию по данным

## Использование

### Запуск полной синхронизации

```bash
# Однократная полная синхронизация
npx tsx src/scripts/run-book-worm.ts

# Планированная синхронизация (выполняет проверку и запускает нужный тип синхронизации)
npx tsx src/scripts/scheduled-book-worm.ts

# Тестовая полная синхронизация
npx tsx src/scripts/test-book-worm-full-sync.ts

# Демонстрация расширенной индексации
npx tsx src/scripts/advanced-metadata-indexing.ts
```

## Логирование

Во время выполнения полной синхронизации выводится подробная информация:

- Общее количество сообщений в канале
- Количество обработанных сообщений
- Количество найденных пропущенных сообщений
- Статистика по добавленным/обновленным книгам
- Статистика по привязанным файлам
- Статистика по индексированным сообщениям

## Особенности реализации

1. **Постраничная загрузка сообщений**:
   - Сообщения загружаются пакетами по 100 штук
   - Между пакетами добавляются небольшие паузы для предотвращения перегрузки Telegram API

2. **Дедупликация данных**:
   - Проверяет существование книг в базе данных перед импортом
   - Предотвращает создание дубликатов записей

3. **Обработка ошибок**:
   - Все ошибки логируются с подробной информацией
   - Выполнение продолжается даже при возникновении отдельных ошибок

4. **Оптимизация производительности**:
   - Используются индексы в базе данных для ускорения поиска
   - Минимизировано количество запросов к Telegram API

5. **Расширенная индексация**:
   - Индексация выполняется с сохранением базовой информации о сообщениях
   - Поддерживается поиск по ключевым словам с ранжированием
   - Ведется статистика по качеству индексированных данных